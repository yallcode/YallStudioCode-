<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YSCode - YallStudio Code</title>
<link rel="icon" href="icon.png" type="image/png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-darkest: #0d0d0f;
    --bg-dark: #141416;
    --bg-mid: #1a1a1e;
    --bg-panel: #1e1e22;
    --bg-hover: #2a2a30;
    --bg-active: #2d2d34;
    --border: #2e2e36;
    --accent: #f0a500;
    --accent2: #e06c75;
    --accent3: #61afef;
    --accent4: #98c379;
    --accent5: #c678dd;
    --text-bright: #f0f0f5;
    --text-main: #c0c0cc;
    --text-dim: #6b6b7a;
    --text-dimmer: #44444f;
    --tab-active: #1e1e22;
    --scrollbar: #2e2e36;
    --font-code: 'JetBrains Mono', monospace;
    --font-ui: 'Syne', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--font-ui);
    background: var(--bg-darkest);
    color: var(--text-main);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    user-select: none;
  }

  /* ‚îÄ‚îÄ TITLE BAR ‚îÄ‚îÄ */
  #titlebar {
    height: 30px;
    background: var(--bg-darkest);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 12px;
    gap: 8px;
    flex-shrink: 0;
    -webkit-app-region: drag;
  }
  #titlebar .logo {
    display: flex; align-items: center; gap: 6px;
    font-weight: 800; font-size: 12px; letter-spacing: 0.05em;
    color: var(--accent);
  }
  #titlebar .logo img { width: 16px; height: 16px; object-fit: contain; }
  #titlebar .logo span { color: var(--text-bright); }
  #titlebar .logo span b { color: var(--accent); }
  #menu-bar {
    display: flex; gap: 2px; margin-left: 8px;
    -webkit-app-region: no-drag;
  }
  .menu-item {
    font-size: 12px; color: var(--text-main); cursor: pointer;
    padding: 4px 8px; border-radius: 4px; font-family: var(--font-ui);
    position: relative;
  }
  .menu-item:hover { background: var(--bg-hover); color: var(--text-bright); }
  .menu-dropdown {
    display: none; position: absolute; top: 100%; left: 0;
    background: var(--bg-panel); border: 1px solid var(--border);
    border-radius: 6px; min-width: 180px; z-index: 1000;
    padding: 4px; box-shadow: 0 8px 24px rgba(0,0,0,0.6);
  }
  .menu-item:hover .menu-dropdown,
  .menu-item.open .menu-dropdown { display: block; }
  .menu-dropdown-item {
    padding: 6px 12px; font-size: 12px; border-radius: 4px;
    cursor: pointer; display: flex; justify-content: space-between;
    gap: 24px; white-space: nowrap;
  }
  .menu-dropdown-item:hover { background: var(--bg-hover); color: var(--text-bright); }
  .menu-dropdown-item .shortcut { color: var(--text-dim); }
  .menu-sep { height: 1px; background: var(--border); margin: 3px 0; }
  #titlebar-title {
    flex: 1; text-align: center; font-size: 11px;
    color: var(--text-dim); letter-spacing: 0.03em;
  }

  /* ‚îÄ‚îÄ ACTIVITY BAR ‚îÄ‚îÄ */
  #activity-bar {
    width: 48px; background: var(--bg-dark);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column; align-items: center;
    padding: 4px 0; gap: 2px; flex-shrink: 0;
  }
  .activity-btn {
    width: 40px; height: 40px; display: flex; align-items: center;
    justify-content: center; cursor: pointer; border-radius: 6px;
    color: var(--text-dim); transition: color 0.15s, background 0.15s;
    font-size: 20px; position: relative;
  }
  .activity-btn:hover { color: var(--text-bright); background: var(--bg-hover); }
  .activity-btn.active { color: var(--text-bright); background: var(--bg-active); }
  .activity-btn.active::before {
    content: ''; position: absolute; left: 0; top: 50%;
    transform: translateY(-50%); width: 2px; height: 20px;
    background: var(--accent); border-radius: 0 2px 2px 0;
  }
  #activity-bar .spacer { flex: 1; }

  /* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
  #workbench {
    display: flex; flex: 1; overflow: hidden;
  }

  /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
  #sidebar {
    width: 240px; background: var(--bg-dark);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column; flex-shrink: 0;
    overflow: hidden;
  }
  #sidebar-header {
    padding: 10px 12px 6px;
    font-size: 10px; font-weight: 700; letter-spacing: 0.1em;
    text-transform: uppercase; color: var(--text-dim);
    display: flex; justify-content: space-between; align-items: center;
  }
  #sidebar-header .sidebar-actions { display: flex; gap: 4px; }
  .sidebar-icon-btn {
    width: 22px; height: 22px; display: flex; align-items: center;
    justify-content: center; cursor: pointer; border-radius: 4px;
    color: var(--text-dim); font-size: 14px;
    transition: color 0.15s, background 0.15s;
  }
  .sidebar-icon-btn:hover { color: var(--text-bright); background: var(--bg-hover); }
  #file-tree {
    flex: 1; overflow-y: auto; padding: 4px 0;
  }
  #file-tree::-webkit-scrollbar { width: 4px; }
  #file-tree::-webkit-scrollbar-track { background: transparent; }
  #file-tree::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 2px; }

  .tree-empty {
    padding: 20px 16px; font-size: 12px; color: var(--text-dim);
    line-height: 1.6;
  }
  .tree-empty .open-btn {
    display: inline-block; margin-top: 10px; padding: 6px 12px;
    background: var(--accent); color: var(--bg-darkest);
    border-radius: 5px; font-size: 11px; font-weight: 700;
    cursor: pointer; font-family: var(--font-ui);
    transition: opacity 0.15s;
  }
  .tree-empty .open-btn:hover { opacity: 0.85; }

  .tree-folder, .tree-file {
    display: flex; align-items: center; gap: 4px;
    padding: 2px 0; cursor: pointer; border-radius: 3px;
    font-size: 13px; font-family: var(--font-code);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .tree-folder:hover, .tree-file:hover { background: var(--bg-hover); }
  .tree-file.active { background: var(--bg-active); color: var(--text-bright); }
  .tree-icon { flex-shrink: 0; font-size: 14px; }
  .tree-name { overflow: hidden; text-overflow: ellipsis; }
  .tree-children { display: none; }
  .tree-children.open { display: block; }

  /* ‚îÄ‚îÄ EDITOR AREA ‚îÄ‚îÄ */
  #editor-area {
    flex: 1; display: flex; flex-direction: column; overflow: hidden;
    background: var(--bg-mid);
  }

  /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
  #tabs-bar {
    height: 35px; background: var(--bg-dark);
    border-bottom: 1px solid var(--border);
    display: flex; overflow-x: auto; flex-shrink: 0;
    align-items: flex-end;
  }
  #tabs-bar::-webkit-scrollbar { height: 2px; }
  #tabs-bar::-webkit-scrollbar-thumb { background: var(--scrollbar); }
  .tab {
    height: 35px; display: flex; align-items: center; gap: 6px;
    padding: 0 12px; font-size: 12px; font-family: var(--font-code);
    cursor: pointer; border-right: 1px solid var(--border);
    color: var(--text-dim); flex-shrink: 0;
    position: relative; transition: color 0.1s, background 0.1s;
    min-width: 80px; max-width: 160px;
  }
  .tab:hover { background: var(--bg-hover); color: var(--text-main); }
  .tab.active {
    background: var(--tab-active); color: var(--text-bright);
    border-top: 1px solid var(--accent);
  }
  .tab-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .tab-close {
    font-size: 14px; opacity: 0; transition: opacity 0.1s;
    border-radius: 3px; padding: 1px 2px; flex-shrink: 0;
  }
  .tab:hover .tab-close, .tab.active .tab-close { opacity: 0.6; }
  .tab-close:hover { opacity: 1 !important; background: var(--bg-hover); }
  .tab-icon { font-size: 13px; flex-shrink: 0; }
  .tab-dirty { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; flex-shrink: 0; }

  /* ‚îÄ‚îÄ EDITOR WELCOME ‚îÄ‚îÄ */
  #welcome {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    color: var(--text-dim);
  }
  #welcome .welcome-logo { font-size: 64px; margin-bottom: 16px; opacity: 0.15; }
  #welcome h2 {
    font-family: var(--font-ui); font-size: 28px; font-weight: 800;
    color: var(--text-bright); opacity: 0.4; letter-spacing: -0.02em;
  }
  #welcome h2 span { color: var(--accent); }
  #welcome p { font-size: 13px; margin-top: 8px; opacity: 0.5; }
  #welcome .shortcuts {
    margin-top: 32px; display: flex; flex-direction: column; gap: 8px;
    font-size: 12px; font-family: var(--font-code);
  }
  #welcome .shortcut-row { display: flex; gap: 12px; align-items: center; }
  #welcome .shortcut-row kbd {
    background: var(--bg-panel); border: 1px solid var(--border);
    padding: 2px 6px; border-radius: 4px; font-family: var(--font-code);
    font-size: 11px;
  }

  /* ‚îÄ‚îÄ CODE EDITOR ‚îÄ‚îÄ */
  #editors-container { flex: 1; position: relative; overflow: hidden; }
  .editor-pane {
    position: absolute; inset: 0; display: none; flex-direction: column;
  }
  .editor-pane.visible { display: flex; }
  .editor-inner {
    flex: 1; display: flex; overflow: hidden;
  }
  .line-numbers {
    background: var(--bg-mid); color: var(--text-dimmer);
    font-family: var(--font-code); font-size: 13px; line-height: 20px;
    padding: 8px 12px 8px 8px; text-align: right; flex-shrink: 0;
    overflow: hidden; white-space: pre; min-width: 48px;
    border-right: 1px solid var(--border); pointer-events: none;
    user-select: none;
  }
  .code-area {
    flex: 1; background: var(--bg-mid); color: var(--text-main);
    font-family: var(--font-code); font-size: 13px; line-height: 20px;
    padding: 8px 16px; border: none; outline: none; resize: none;
    overflow-y: auto; overflow-x: auto; caret-color: var(--accent);
    white-space: pre; tab-size: 2;
  }
  .code-area::-webkit-scrollbar { width: 8px; height: 8px; }
  .code-area::-webkit-scrollbar-track { background: var(--bg-mid); }
  .code-area::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 4px; }
  .code-area::selection { background: rgba(240,165,0,0.2); }
  .editor-breadcrumb {
    height: 22px; background: var(--bg-panel); border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 12px; gap: 4px;
    font-size: 11px; font-family: var(--font-code); color: var(--text-dim);
    flex-shrink: 0;
  }
  .breadcrumb-sep { color: var(--text-dimmer); }

  /* ‚îÄ‚îÄ STATUS BAR ‚îÄ‚îÄ */
  #statusbar {
    height: 22px; background: var(--accent);
    display: flex; align-items: center; padding: 0 12px;
    gap: 16px; flex-shrink: 0;
  }
  #statusbar .status-item {
    font-size: 11px; color: var(--bg-darkest); font-weight: 600;
    cursor: pointer; display: flex; align-items: center; gap: 4px;
    font-family: var(--font-ui);
  }
  #statusbar .status-item:hover { opacity: 0.75; }
  #statusbar .spacer { flex: 1; }
  #statusbar .status-right { display: flex; gap: 16px; }

  /* ‚îÄ‚îÄ TERMINAL ‚îÄ‚îÄ */
  #terminal-panel {
    height: 180px; background: var(--bg-darkest);
    border-top: 1px solid var(--border); flex-shrink: 0;
    display: none; flex-direction: column;
  }
  #terminal-panel.visible { display: flex; }
  #terminal-header {
    height: 30px; background: var(--bg-dark); border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 12px; gap: 8px;
    font-size: 11px; font-family: var(--font-ui);
  }
  .terminal-tab { 
    padding: 4px 10px; border-radius: 4px; cursor: pointer;
    font-size: 11px;
  }
  .terminal-tab.active { background: var(--bg-active); color: var(--text-bright); }
  #terminal-close {
    margin-left: auto; cursor: pointer; color: var(--text-dim);
    font-size: 16px; width: 22px; height: 22px; display: flex;
    align-items: center; justify-content: center; border-radius: 4px;
  }
  #terminal-close:hover { background: var(--bg-hover); color: var(--text-bright); }
  #terminal-output {
    flex: 1; overflow-y: auto; padding: 8px 12px;
    font-family: var(--font-code); font-size: 12px; line-height: 18px;
    color: var(--text-main);
  }
  #terminal-output::-webkit-scrollbar { width: 4px; }
  #terminal-output::-webkit-scrollbar-thumb { background: var(--scrollbar); }
  #terminal-input-row {
    display: flex; align-items: center; padding: 4px 12px 8px;
    gap: 6px; font-family: var(--font-code); font-size: 12px;
  }
  #terminal-prompt { color: var(--accent4); }
  #terminal-input {
    flex: 1; background: transparent; border: none; outline: none;
    color: var(--text-bright); font-family: var(--font-code); font-size: 12px;
    caret-color: var(--accent);
  }

  /* ‚îÄ‚îÄ CONTEXT MENU ‚îÄ‚îÄ */
  #ctx-menu {
    display: none; position: fixed; z-index: 9999;
    background: var(--bg-panel); border: 1px solid var(--border);
    border-radius: 6px; padding: 4px; min-width: 160px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.6); font-size: 12px;
  }
  .ctx-item {
    padding: 6px 10px; border-radius: 4px; cursor: pointer;
    display: flex; justify-content: space-between; gap: 16px;
  }
  .ctx-item:hover { background: var(--bg-hover); color: var(--text-bright); }
  .ctx-sep { height: 1px; background: var(--border); margin: 3px 0; }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  #modal-overlay {
    display: none; position: fixed; inset: 0; z-index: 9998;
    background: rgba(0,0,0,0.7); align-items: flex-start; justify-content: center;
    padding-top: 100px;
  }
  #modal-overlay.visible { display: flex; }
  #modal {
    background: var(--bg-panel); border: 1px solid var(--border);
    border-radius: 10px; width: 500px; padding: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.8);
  }
  #modal h3 { font-size: 14px; color: var(--text-bright); margin-bottom: 12px; }
  #modal input {
    width: 100%; background: var(--bg-dark); border: 1px solid var(--border);
    color: var(--text-bright); padding: 8px 12px; border-radius: 6px;
    font-family: var(--font-code); font-size: 13px; outline: none;
  }
  #modal input:focus { border-color: var(--accent); }
  #modal .modal-btns { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
  #modal button {
    padding: 7px 16px; border-radius: 5px; font-size: 12px;
    font-family: var(--font-ui); font-weight: 600; cursor: pointer; border: none;
  }
  #modal .btn-primary { background: var(--accent); color: var(--bg-darkest); }
  #modal .btn-secondary { background: var(--bg-hover); color: var(--text-main); }
  #modal button:hover { opacity: 0.85; }

  /* ‚îÄ‚îÄ RESIZER ‚îÄ‚îÄ */
  #sidebar-resizer {
    width: 4px; background: transparent; cursor: col-resize;
    flex-shrink: 0; transition: background 0.2s;
  }
  #sidebar-resizer:hover { background: var(--accent); }

  /* ‚îÄ‚îÄ SEARCH PANEL ‚îÄ‚îÄ */
  #search-panel {
    flex: 1; overflow-y: auto; padding: 8px;
  }
  .search-input-wrap {
    position: relative; margin-bottom: 8px;
  }
  .search-input-wrap input {
    width: 100%; background: var(--bg-mid); border: 1px solid var(--border);
    color: var(--text-bright); padding: 6px 10px; border-radius: 5px;
    font-family: var(--font-code); font-size: 12px; outline: none;
  }
  .search-input-wrap input:focus { border-color: var(--accent); }
  .search-result {
    padding: 4px 8px; border-radius: 4px; cursor: pointer;
    font-family: var(--font-code); font-size: 11px; line-height: 1.6;
  }
  .search-result:hover { background: var(--bg-hover); }
  .search-result .file-name { color: var(--accent3); font-weight: 500; }
  .search-result .match { color: var(--text-main); }
  .search-result mark { background: rgba(240,165,0,0.3); color: var(--accent); border-radius: 2px; }

  /* sidebar panel visibility */
  .sidebar-panel { display: none; flex-direction: column; flex: 1; overflow: hidden; }
  .sidebar-panel.active { display: flex; }

  /* Syntax token colors - applied via JS */
  .tok-keyword { color: #c678dd; }
  .tok-string { color: #98c379; }
  .tok-comment { color: #5c6370; font-style: italic; }
  .tok-number { color: #d19a66; }
  .tok-function { color: #61afef; }
  .tok-tag { color: #e06c75; }
  .tok-attr { color: #d19a66; }
  .tok-operator { color: #56b6c2; }
</style>
</head>
<body>

<!-- TITLE BAR -->
<div id="titlebar">
  <div class="logo">
    <img src="icon.png" alt="YSCode" onerror="this.style.display='none'">
    <b>YS</b><span>Code</span>
  </div>
  <nav id="menu-bar">
    <div class="menu-item" onclick="toggleMenu(this)">File
      <div class="menu-dropdown">
        <div class="menu-dropdown-item" onclick="openFolder()">Open Folder‚Ä¶ <span class="shortcut">Ctrl+K O</span></div>
        <div class="menu-dropdown-item" onclick="newFile()">New File <span class="shortcut">Ctrl+N</span></div>
        <div class="menu-sep"></div>
        <div class="menu-dropdown-item" onclick="saveFile()">Save <span class="shortcut">Ctrl+S</span></div>
        <div class="menu-dropdown-item" onclick="saveFileAs()">Save As‚Ä¶ <span class="shortcut">Ctrl+Shift+S</span></div>
        <div class="menu-sep"></div>
        <div class="menu-dropdown-item" onclick="closeTab()">Close Tab <span class="shortcut">Ctrl+W</span></div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this)">Edit
      <div class="menu-dropdown">
        <div class="menu-dropdown-item" onclick="document.execCommand('undo')">Undo <span class="shortcut">Ctrl+Z</span></div>
        <div class="menu-dropdown-item" onclick="document.execCommand('redo')">Redo <span class="shortcut">Ctrl+Y</span></div>
        <div class="menu-sep"></div>
        <div class="menu-dropdown-item" onclick="document.execCommand('copy')">Copy <span class="shortcut">Ctrl+C</span></div>
        <div class="menu-dropdown-item" onclick="document.execCommand('paste')">Paste <span class="shortcut">Ctrl+V</span></div>
        <div class="menu-dropdown-item" onclick="document.execCommand('selectAll')">Select All <span class="shortcut">Ctrl+A</span></div>
        <div class="menu-sep"></div>
        <div class="menu-dropdown-item" onclick="openFindBar()">Find <span class="shortcut">Ctrl+F</span></div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this)">View
      <div class="menu-dropdown">
        <div class="menu-dropdown-item" onclick="toggleTerminal()">Terminal <span class="shortcut">Ctrl+`</span></div>
        <div class="menu-dropdown-item" onclick="toggleSidebar()">Toggle Sidebar <span class="shortcut">Ctrl+B</span></div>
        <div class="menu-sep"></div>
        <div class="menu-dropdown-item" onclick="setActivity('explorer')">Explorer</div>
        <div class="menu-dropdown-item" onclick="setActivity('search')">Search</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this)">Help
      <div class="menu-dropdown">
        <div class="menu-dropdown-item" onclick="window.open('https://yallcode.github.io/YallCode/','_blank')">YallCode Website</div>
        <div class="menu-dropdown-item">About YSCode</div>
      </div>
    </div>
  </nav>
  <div id="titlebar-title">YSCode ‚Äì YallStudio Code</div>
</div>

<!-- MAIN WORKBENCH -->
<div id="workbench">

  <!-- ACTIVITY BAR -->
  <div id="activity-bar">
    <div class="activity-btn active" id="act-explorer" title="Explorer" onclick="setActivity('explorer')">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="7" height="18" rx="1"/><rect x="14" y="3" width="7" height="8" rx="1"/><rect x="14" y="15" width="7" height="6" rx="1"/></svg>
    </div>
    <div class="activity-btn" id="act-search" title="Search" onclick="setActivity('search')">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/></svg>
    </div>
    <div class="activity-btn" id="act-git" title="Source Control" onclick="setActivity('git')">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="6" cy="6" r="2"/><circle cx="6" cy="18" r="2"/><circle cx="18" cy="9" r="2"/><line x1="6" y1="8" x2="6" y2="16"/><path d="M6 8c0 0 6-2 12 0"/></svg>
    </div>
    <div class="spacer"></div>
    <div class="activity-btn" id="act-settings" title="Settings" onclick="openSettings()">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M12 2v2m0 16v2M4.22 4.22l1.42 1.42m12.72 12.72 1.42 1.42M2 12h2m16 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div id="sidebar">

    <!-- EXPLORER PANEL -->
    <div class="sidebar-panel active" id="panel-explorer">
      <div id="sidebar-header">
        <span>Explorer</span>
        <div class="sidebar-actions">
          <div class="sidebar-icon-btn" title="New File" onclick="newFileInFolder()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>
          </div>
          <div class="sidebar-icon-btn" title="New Folder" onclick="newFolderInTree()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>
          </div>
          <div class="sidebar-icon-btn" title="Open Folder" onclick="openFolder()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
          </div>
          <div class="sidebar-icon-btn" title="Refresh" onclick="refreshTree()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
          </div>
        </div>
      </div>
      <div id="file-tree">
        <div class="tree-empty">
          <div>No folder opened.</div>
          <div style="margin-top:4px">Open a folder to explore your files.</div>
          <div class="open-btn" onclick="openFolder()">Open Folder</div>
        </div>
      </div>
    </div>

    <!-- SEARCH PANEL -->
    <div class="sidebar-panel" id="panel-search">
      <div id="sidebar-header" style="justify-content:flex-start">
        <span>Search</span>
      </div>
      <div id="search-panel">
        <div class="search-input-wrap">
          <input type="text" id="search-input" placeholder="Search in files‚Ä¶" oninput="doSearch(this.value)" />
        </div>
        <div id="search-results"></div>
      </div>
    </div>

    <!-- GIT PANEL -->
    <div class="sidebar-panel" id="panel-git">
      <div id="sidebar-header" style="justify-content:flex-start">
        <span>Source Control</span>
      </div>
      <div style="padding:16px;font-size:12px;color:var(--text-dim)">No repository detected in the current folder.</div>
    </div>

  </div>

  <!-- SIDEBAR RESIZER -->
  <div id="sidebar-resizer"></div>

  <!-- EDITOR AREA -->
  <div id="editor-area">
    <div id="tabs-bar"></div>

    <div id="editors-container">
      <!-- Welcome screen -->
      <div id="welcome">
        <div class="welcome-logo">
          <svg width="64" height="64" viewBox="0 0 64 64" fill="none"><rect width="64" height="64" rx="12" fill="rgba(240,165,0,0.1)"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="36" font-family="Syne,sans-serif" font-weight="800" fill="#f0a500">YS</text></svg>
        </div>
        <h2><span>YS</span>Code</h2>
        <p>YallStudio Code ‚Äî A powerful web-based editor</p>
        <div class="shortcuts">
          <div class="shortcut-row"><kbd>Ctrl+N</kbd> New File</div>
          <div class="shortcut-row"><kbd>Ctrl+K O</kbd> Open Folder</div>
          <div class="shortcut-row"><kbd>Ctrl+`</kbd> Toggle Terminal</div>
          <div class="shortcut-row"><kbd>Ctrl+B</kbd> Toggle Sidebar</div>
        </div>
      </div>
    </div>

    <!-- TERMINAL -->
    <div id="terminal-panel">
      <div id="terminal-header">
        <div class="terminal-tab active">TERMINAL</div>
        <div class="terminal-tab">PROBLEMS</div>
        <div class="terminal-tab">OUTPUT</div>
        <div id="terminal-close" onclick="toggleTerminal()">‚úï</div>
      </div>
      <div id="terminal-output"><span style="color:var(--accent4)">YSCode Terminal v1.0.0</span><br><span style="color:var(--text-dim)">Web-based terminal ‚Äî type 'help' for commands</span><br><br></div>
      <div id="terminal-input-row">
        <span id="terminal-prompt">user@yscode:~$</span>
        <input type="text" id="terminal-input" placeholder="Enter command‚Ä¶" spellcheck="false" onkeydown="handleTerminalKey(event)" />
      </div>
    </div>
  </div>
</div>

<!-- STATUS BAR -->
<div id="statusbar">
  <div class="status-item" onclick="setActivity('git')">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="6" cy="6" r="2"/><circle cx="6" cy="18" r="2"/><circle cx="18" cy="9" r="2"/><line x1="6" y1="8" x2="6" y2="16"/><path d="M6 8c0 0 6-2 12 0"/></svg>
    main
  </div>
  <div class="status-item" id="status-file">No file open</div>
  <div class="spacer"></div>
  <div class="status-right">
    <div class="status-item" id="status-cursor">Ln 1, Col 1</div>
    <div class="status-item" id="status-lang">Plain Text</div>
    <div class="status-item" onclick="window.open('https://yallcode.github.io/YallCode/','_blank')">YallCode ‚Üó</div>
  </div>
</div>

<!-- CONTEXT MENU -->
<div id="ctx-menu">
  <div class="ctx-item" id="ctx-open">Open</div>
  <div class="ctx-item" id="ctx-rename">Rename</div>
  <div class="ctx-item" id="ctx-delete">Delete</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="newFileInFolder()">New File</div>
  <div class="ctx-item" onclick="newFolderInTree()">New Folder</div>
</div>

<!-- MODAL -->
<div id="modal-overlay">
  <div id="modal">
    <h3 id="modal-title">New File</h3>
    <input type="text" id="modal-input" placeholder="filename.js" />
    <div class="modal-btns">
      <button class="btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn-primary" id="modal-confirm">Create</button>
    </div>
  </div>
</div>

<!-- HIDDEN FILE INPUT -->
<input type="file" id="file-input" style="display:none" webkitdirectory multiple />
<input type="file" id="single-file-input" style="display:none" multiple />

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const state = {
  files: {},          // path -> {name, content, dirty, lang}
  folders: {},        // path -> {name, children: [path], isFolder}
  rootPath: null,
  openTabs: [],
  activeTab: null,
  currentActivity: 'explorer',
  sidebarVisible: true,
  terminalVisible: false,
  contextTarget: null,
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ LANGUAGE DETECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const langMap = {
  js: 'JavaScript', ts: 'TypeScript', jsx: 'React JSX', tsx: 'React TSX',
  html: 'HTML', css: 'CSS', scss: 'SCSS', json: 'JSON',
  py: 'Python', md: 'Markdown', txt: 'Plain Text', sh: 'Shell',
  yaml: 'YAML', yml: 'YAML', xml: 'XML', c: 'C', cpp: 'C++',
  java: 'Java', rs: 'Rust', go: 'Go', php: 'PHP', rb: 'Ruby',
};
const iconMap = {
  js: 'üü®', ts: 'üî∑', jsx: '‚öõÔ∏è', tsx: '‚öõÔ∏è', html: 'üåê', css: 'üé®',
  scss: 'üé®', json: 'üìã', py: 'üêç', md: 'üìù', txt: 'üìÑ', sh: 'üí≤',
  yaml: '‚öôÔ∏è', yml: '‚öôÔ∏è', xml: 'üì∞', c: 'üîµ', cpp: 'üîµ',
  java: '‚òï', rs: 'ü¶Ä', go: 'üêπ', php: 'üêò', rb: 'üíé',
};
function getLang(name) {
  const ext = (name.split('.').pop() || '').toLowerCase();
  return langMap[ext] || 'Plain Text';
}
function getIcon(name) {
  const ext = (name.split('.').pop() || '').toLowerCase();
  return iconMap[ext] || 'üìÑ';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ OPEN FOLDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openFolder() {
  document.getElementById('file-input').click();
}
document.getElementById('file-input').addEventListener('change', async function(e) {
  const files = Array.from(e.target.files);
  if (!files.length) return;
  state.files = {}; state.folders = {}; state.rootPath = null;
  state.openTabs = []; state.activeTab = null;
  renderTabs(); renderWelcome();

  // Build tree structure
  const rootParts = files[0].webkitRelativePath.split('/');
  const rootName = rootParts[0];
  state.rootPath = rootName;
  state.folders[rootName] = { name: rootName, children: [], isFolder: true, depth: 0 };

  for (const file of files) {
    const parts = file.webkitRelativePath.split('/');
    const filePath = file.webkitRelativePath;

    // Ensure all parent folders exist
    for (let i = 1; i < parts.length; i++) {
      const folderPath = parts.slice(0, i).join('/');
      const parentPath = parts.slice(0, i - 1).join('/') || rootName;
      if (!state.folders[folderPath] && i < parts.length - 1) {
        state.folders[folderPath] = { name: parts[i - 1], children: [], isFolder: true, depth: i - 1 };
        const parent = state.folders[parentPath];
        if (parent && !parent.children.includes(folderPath)) parent.children.push(folderPath);
      }
    }

    // Add file
    const parentPath = parts.slice(0, -1).join('/');
    const parent = state.folders[parentPath];
    if (parent && !parent.children.includes(filePath)) parent.children.push(filePath);

    state.files[filePath] = {
      name: parts[parts.length - 1],
      content: null, // lazy load
      dirty: false,
      lang: getLang(parts[parts.length - 1]),
      fileObj: file,
    };
  }

  renderTree();
  updateTitlebar(rootName);
  this.value = '';
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TREE RENDERING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTree() {
  const tree = document.getElementById('file-tree');
  if (!state.rootPath) {
    tree.innerHTML = `<div class="tree-empty"><div>No folder opened.</div><div style="margin-top:4px">Open a folder to explore your files.</div><div class="open-btn" onclick="openFolder()">Open Folder</div></div>`;
    return;
  }
  tree.innerHTML = '';
  renderNode(state.rootPath, tree, 0, true);
}

function renderNode(path, container, depth, isRoot) {
  const node = state.folders[path] || state.files[path];
  if (!node) return;

  const isFolder = !!state.folders[path];
  const el = document.createElement('div');
  const indent = depth * 12;

  if (isFolder) {
    const isOpen = el.dataset.open !== 'false';
    el.className = 'tree-folder';
    el.style.paddingLeft = `${8 + indent}px`;
    el.innerHTML = `<span class="tree-icon">${isRoot ? 'üìÇ' : (el.dataset.open ? 'üìÇ' : 'üìÅ')}</span><span class="tree-name">${node.name}</span>`;
    if (isRoot) el.dataset.open = 'true';
    el.dataset.path = path;
    el.dataset.open = isRoot ? 'true' : 'false';

    const childContainer = document.createElement('div');
    childContainer.className = 'tree-children' + (isRoot ? ' open' : '');
    childContainer.dataset.parent = path;

    el.addEventListener('click', (e) => {
      e.stopPropagation();
      const open = el.dataset.open === 'true';
      el.dataset.open = open ? 'false' : 'true';
      el.querySelector('.tree-icon').textContent = (!open) ? 'üìÇ' : 'üìÅ';
      childContainer.classList.toggle('open', !open);
    });
    el.addEventListener('contextmenu', (e) => showCtxMenu(e, path, true));

    container.appendChild(el);
    container.appendChild(childContainer);

    // Sort children: folders first, then files
    const children = (node.children || []).slice().sort((a, b) => {
      const aIsFolder = !!state.folders[a];
      const bIsFolder = !!state.folders[b];
      if (aIsFolder !== bIsFolder) return aIsFolder ? -1 : 1;
      return (state.folders[a] || state.files[a]).name.localeCompare((state.folders[b] || state.files[b]).name);
    });

    for (const child of children) renderNode(child, childContainer, depth + 1, false);
  } else {
    el.className = 'tree-file';
    el.style.paddingLeft = `${8 + indent}px`;
    const icon = getIcon(node.name);
    el.innerHTML = `<span class="tree-icon">${icon}</span><span class="tree-name">${node.name}</span>`;
    el.dataset.path = path;
    if (state.activeTab === path) el.classList.add('active');

    el.addEventListener('click', () => openFile(path));
    el.addEventListener('contextmenu', (e) => showCtxMenu(e, path, false));
    container.appendChild(el);
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ OPEN FILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openFile(path) {
  const file = state.files[path];
  if (!file) return;

  // Update active tree item
  document.querySelectorAll('.tree-file').forEach(el => el.classList.remove('active'));
  const treeEl = document.querySelector(`.tree-file[data-path="${CSS.escape(path)}"]`);
  if (treeEl) treeEl.classList.add('active');

  // Add tab if not already open
  if (!state.openTabs.includes(path)) state.openTabs.push(path);
  state.activeTab = path;

  // Lazy load content
  if (file.content === null && file.fileObj) {
    file.content = await file.fileObj.text();
  }

  renderTabs();
  renderEditor(path);
  updateStatus(path);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTabs() {
  const bar = document.getElementById('tabs-bar');
  bar.innerHTML = '';
  for (const path of state.openTabs) {
    const file = state.files[path];
    if (!file) continue;
    const tab = document.createElement('div');
    tab.className = 'tab' + (path === state.activeTab ? ' active' : '');
    tab.innerHTML = `
      <span class="tab-icon">${getIcon(file.name)}</span>
      <span class="tab-name">${file.name}</span>
      ${file.dirty ? '<span class="tab-dirty"></span>' : ''}
      <span class="tab-close" onclick="closeTabByPath(event,'${CSS.escape(path)}')">‚úï</span>
    `;
    tab.addEventListener('click', () => switchTab(path));
    bar.appendChild(tab);
  }
  if (state.openTabs.length === 0) renderWelcome();
}

function switchTab(path) {
  state.activeTab = path;
  renderTabs();
  renderEditor(path);
  updateStatus(path);
}

function closeTabByPath(e, path) {
  e.stopPropagation();
  const realPath = path.replace(/\\(.)/g, '$1');
  closeTabAt(realPath);
}
function closeTab() { if (state.activeTab) closeTabAt(state.activeTab); }
function closeTabAt(path) {
  const idx = state.openTabs.indexOf(path);
  if (idx === -1) return;
  state.openTabs.splice(idx, 1);
  if (state.activeTab === path) {
    state.activeTab = state.openTabs[idx] || state.openTabs[idx - 1] || null;
  }
  // Remove editor pane
  const pane = document.getElementById('pane-' + btoa(unescape(encodeURIComponent(path))).replace(/[^a-zA-Z0-9]/g,''));
  if (pane) pane.remove();
  renderTabs();
  if (state.activeTab) renderEditor(state.activeTab);
  else renderWelcome();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ EDITOR RENDERING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderWelcome() {
  document.getElementById('welcome').style.display = 'flex';
  document.querySelectorAll('.editor-pane').forEach(p => p.classList.remove('visible'));
}

function paneId(path) {
  return 'pane-' + btoa(unescape(encodeURIComponent(path))).replace(/[^a-zA-Z0-9]/g,'').substring(0,20);
}

function renderEditor(path) {
  const file = state.files[path];
  if (!file) return;
  document.getElementById('welcome').style.display = 'none';
  document.querySelectorAll('.editor-pane').forEach(p => p.classList.remove('visible'));

  const pid = paneId(path);
  let pane = document.getElementById(pid);
  if (!pane) {
    pane = document.createElement('div');
    pane.className = 'editor-pane';
    pane.id = pid;

    const breadcrumb = document.createElement('div');
    breadcrumb.className = 'editor-breadcrumb';
    breadcrumb.innerHTML = `<span style="color:var(--text-dim)">${state.rootPath || ''}</span><span class="breadcrumb-sep"> ‚Ä∫ </span><span style="color:var(--accent3)">${file.name}</span>`;

    const inner = document.createElement('div');
    inner.className = 'editor-inner';

    const lineNums = document.createElement('div');
    lineNums.className = 'line-numbers';

    const textarea = document.createElement('textarea');
    textarea.className = 'code-area';
    textarea.spellcheck = false;
    textarea.value = file.content || '';
    updateLineNumbers(lineNums, textarea.value);

    textarea.addEventListener('input', () => {
      file.content = textarea.value;
      file.dirty = true;
      updateLineNumbers(lineNums, textarea.value);
      renderTabs();
    });
    textarea.addEventListener('keydown', (e) => handleEditorKey(e, textarea, path));
    textarea.addEventListener('click', () => updateCursor(textarea));
    textarea.addEventListener('keyup', () => updateCursor(textarea));
    textarea.addEventListener('scroll', () => { lineNums.scrollTop = textarea.scrollTop; });

    inner.appendChild(lineNums);
    inner.appendChild(textarea);
    pane.appendChild(breadcrumb);
    pane.appendChild(inner);
    document.getElementById('editors-container').appendChild(pane);
  }

  pane.classList.add('visible');
  const ta = pane.querySelector('.code-area');
  if (ta) setTimeout(() => { ta.focus(); updateCursor(ta); }, 50);
}

function updateLineNumbers(el, text) {
  const lines = text.split('\n').length;
  el.textContent = Array.from({length: lines}, (_, i) => i + 1).join('\n');
}

function updateCursor(ta) {
  const text = ta.value.substring(0, ta.selectionStart);
  const lines = text.split('\n');
  const ln = lines.length;
  const col = lines[lines.length - 1].length + 1;
  document.getElementById('status-cursor').textContent = `Ln ${ln}, Col ${col}`;
}

function updateStatus(path) {
  const file = state.files[path];
  if (!file) return;
  document.getElementById('status-file').textContent = file.name;
  document.getElementById('status-lang').textContent = file.lang;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ KEYBOARD SHORTCUTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleEditorKey(e, ta, path) {
  if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveFile(); return; }
  if (e.ctrlKey && e.key === 'w') { e.preventDefault(); closeTab(); return; }

  // Tab key -> indent with 2 spaces
  if (e.key === 'Tab') {
    e.preventDefault();
    const start = ta.selectionStart;
    const end = ta.selectionEnd;
    ta.value = ta.value.substring(0, start) + '  ' + ta.value.substring(end);
    ta.selectionStart = ta.selectionEnd = start + 2;
    state.files[path].content = ta.value;
    state.files[path].dirty = true;
    const ln = ta.closest('.editor-pane').querySelector('.line-numbers');
    if (ln) updateLineNumbers(ln, ta.value);
    renderTabs();
  }

  // Auto-close brackets
  const pairs = {'(':')', '[':']', '{':'}', '"':'"', "'":"'"};
  if (pairs[e.key]) {
    const start = ta.selectionStart;
    const end = ta.selectionEnd;
    if (start === end) {
      e.preventDefault();
      const open = e.key, close = pairs[e.key];
      ta.value = ta.value.substring(0, start) + open + close + ta.value.substring(end);
      ta.selectionStart = ta.selectionEnd = start + 1;
      state.files[path].content = ta.value;
    }
  }
}

document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.key === 'n') { e.preventDefault(); newFile(); }
  if (e.ctrlKey && e.key === 'b') { e.preventDefault(); toggleSidebar(); }
  if (e.ctrlKey && e.key === '`') { e.preventDefault(); toggleTerminal(); }
  if (e.ctrlKey && e.key === 'w') { e.preventDefault(); closeTab(); }
  if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveFile(); }
  if (e.key === 'Escape') { closeCtxMenu(); closeModal(); closeAllMenus(); }
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SAVE FILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveFile() {
  if (!state.activeTab) { newFile(); return; }
  const file = state.files[state.activeTab];
  if (!file) return;
  const blob = new Blob([file.content || ''], {type: 'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = file.name;
  a.click();
  file.dirty = false;
  renderTabs();
  showToast(`Saved: ${file.name}`);
}

function saveFileAs() {
  showModalPrompt('Save As', state.activeTab ? state.files[state.activeTab]?.name : 'untitled.txt', (name) => {
    if (!state.activeTab) return;
    const file = state.files[state.activeTab];
    const blob = new Blob([file.content || ''], {type: 'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    file.dirty = false;
    renderTabs();
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ NEW FILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function newFile() {
  showModalPrompt('New File', 'untitled.txt', (name) => {
    if (!name) return;
    const path = (state.rootPath ? state.rootPath + '/' : '') + name;
    state.files[path] = { name, content: '', dirty: false, lang: getLang(name), fileObj: null };
    if (state.rootPath && state.folders[state.rootPath]) {
      state.folders[state.rootPath].children.push(path);
    }
    renderTree();
    openFile(path);
  });
}
function newFileInFolder() { newFile(); }

function newFolderInTree() {
  showModalPrompt('New Folder', 'new-folder', (name) => {
    if (!name || !state.rootPath) return;
    const path = state.rootPath + '/' + name;
    state.folders[path] = { name, children: [], isFolder: true, depth: 1 };
    state.folders[state.rootPath].children.push(path);
    renderTree();
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SINGLE FILE OPEN (drag/drop) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('single-file-input').addEventListener('change', async function(e) {
  for (const file of e.target.files) {
    const path = file.name;
    state.files[path] = {
      name: file.name, content: await file.text(),
      dirty: false, lang: getLang(file.name), fileObj: null,
    };
    openFile(path);
  }
  this.value = '';
});

// Drag & drop files onto editor
document.getElementById('editors-container').addEventListener('dragover', e => e.preventDefault());
document.getElementById('editors-container').addEventListener('drop', async e => {
  e.preventDefault();
  for (const file of e.dataTransfer.files) {
    const path = file.name;
    state.files[path] = {
      name: file.name, content: await file.text(),
      dirty: false, lang: getLang(file.name), fileObj: null,
    };
    openFile(path);
  }
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ACTIVITY SWITCHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setActivity(name) {
  closeAllMenus();
  state.currentActivity = name;
  document.querySelectorAll('.activity-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('act-' + name)?.classList.add('active');
  document.querySelectorAll('.sidebar-panel').forEach(p => p.classList.remove('active'));
  const panel = document.getElementById('panel-' + name);
  if (panel) panel.classList.add('active');
  if (!state.sidebarVisible) toggleSidebar();
}

function toggleSidebar() {
  state.sidebarVisible = !state.sidebarVisible;
  document.getElementById('sidebar').style.display = state.sidebarVisible ? '' : 'none';
  document.getElementById('sidebar-resizer').style.display = state.sidebarVisible ? '' : 'none';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TERMINAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleTerminal() {
  state.terminalVisible = !state.terminalVisible;
  document.getElementById('terminal-panel').classList.toggle('visible', state.terminalVisible);
  if (state.terminalVisible) document.getElementById('terminal-input').focus();
}

const termHistory = [];
let termHistIdx = -1;

const termCommands = {
  help: () => `Available commands:\n  clear       ‚Äì clear terminal\n  ls          ‚Äì list open files\n  pwd         ‚Äì print working directory\n  echo [text] ‚Äì print text\n  date        ‚Äì show current date/time\n  about       ‚Äì about YSCode`,
  clear: () => { document.getElementById('terminal-output').innerHTML = ''; return null; },
  ls: () => Object.values(state.files).map(f => f.name).join('  ') || '(no files open)',
  pwd: () => state.rootPath ? '/' + state.rootPath : '/home/user',
  date: () => new Date().toString(),
  about: () => 'YSCode v1.0.0 ‚Äî YallStudio Code\nMade for the community ‚ù§Ô∏è\nhttps://yallcode.github.io/YallCode/',
};

function handleTerminalKey(e) {
  const input = document.getElementById('terminal-input');
  if (e.key === 'Enter') {
    const cmd = input.value.trim();
    if (!cmd) return;
    termHistory.unshift(cmd); termHistIdx = -1;
    const out = document.getElementById('terminal-output');
    out.innerHTML += `<span style="color:var(--accent4)">$</span> <span style="color:var(--text-bright)">${escHtml(cmd)}</span>\n`;
    const parts = cmd.split(' ');
    const fn = termCommands[parts[0]];
    if (fn) {
      const res = fn(parts.slice(1).join(' '));
      if (res !== null && res !== undefined) out.innerHTML += escHtml(res) + '\n';
    } else if (parts[0] === 'echo') {
      out.innerHTML += escHtml(parts.slice(1).join(' ')) + '\n';
    } else {
      out.innerHTML += `<span style="color:var(--accent2)">Command not found: ${escHtml(parts[0])}</span>\n`;
    }
    out.innerHTML += '\n';
    out.scrollTop = out.scrollHeight;
    input.value = '';
  } else if (e.key === 'ArrowUp') {
    termHistIdx = Math.min(termHistIdx + 1, termHistory.length - 1);
    input.value = termHistory[termHistIdx] || '';
  } else if (e.key === 'ArrowDown') {
    termHistIdx = Math.max(termHistIdx - 1, -1);
    input.value = termHistIdx >= 0 ? termHistory[termHistIdx] : '';
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doSearch(query) {
  const results = document.getElementById('search-results');
  results.innerHTML = '';
  if (!query.trim()) return;
  const q = query.toLowerCase();
  let found = 0;
  for (const [path, file] of Object.entries(state.files)) {
    if (!file.content) continue;
    const lines = file.content.split('\n');
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].toLowerCase().includes(q)) {
        const div = document.createElement('div');
        div.className = 'search-result';
        const hl = lines[i].replace(new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'gi'), m => `<mark>${escHtml(m)}</mark>`);
        div.innerHTML = `<div class="file-name">${escHtml(file.name)}:${i+1}</div><div class="match">${hl}</div>`;
        div.addEventListener('click', () => { openFile(path); setActivity('explorer'); });
        results.appendChild(div);
        if (++found >= 50) return;
      }
    }
  }
  if (!found) results.innerHTML = '<div style="padding:8px;font-size:11px;color:var(--text-dim)">No results found.</div>';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CONTEXT MENU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showCtxMenu(e, path, isFolder) {
  e.preventDefault();
  state.contextTarget = path;
  const menu = document.getElementById('ctx-menu');
  document.getElementById('ctx-open').style.display = isFolder ? 'none' : '';
  menu.style.display = 'block';
  menu.style.left = Math.min(e.clientX, window.innerWidth - 180) + 'px';
  menu.style.top = Math.min(e.clientY, window.innerHeight - 180) + 'px';
  document.getElementById('ctx-open').onclick = () => { openFile(path); closeCtxMenu(); };
  document.getElementById('ctx-rename').onclick = () => {
    const node = state.files[path] || state.folders[path];
    showModalPrompt('Rename', node.name, (name) => {
      if (name) { node.name = name; renderTree(); }
    });
    closeCtxMenu();
  };
  document.getElementById('ctx-delete').onclick = () => {
    if (state.files[path]) {
      delete state.files[path];
      closeTabAt(path);
    } else {
      delete state.folders[path];
    }
    renderTree();
    closeCtxMenu();
  };
}
function closeCtxMenu() { document.getElementById('ctx-menu').style.display = 'none'; }
document.addEventListener('click', closeCtxMenu);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let modalCallback = null;
function showModalPrompt(title, placeholder, cb) {
  document.getElementById('modal-title').textContent = title;
  const input = document.getElementById('modal-input');
  input.placeholder = placeholder;
  input.value = placeholder;
  document.getElementById('modal-overlay').classList.add('visible');
  modalCallback = cb;
  setTimeout(() => { input.focus(); input.select(); }, 50);
  document.getElementById('modal-confirm').onclick = () => {
    if (modalCallback) modalCallback(input.value.trim());
    closeModal();
  };
  input.onkeydown = (e) => { if (e.key === 'Enter') document.getElementById('modal-confirm').click(); };
}
function closeModal() {
  document.getElementById('modal-overlay').classList.remove('visible');
  modalCallback = null;
}
document.getElementById('modal-overlay').addEventListener('click', function(e) { if (e.target === this) closeModal(); });

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MENU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleMenu(el) { el.classList.toggle('open'); }
function closeAllMenus() { document.querySelectorAll('.menu-item.open').forEach(m => m.classList.remove('open')); }
document.addEventListener('click', (e) => { if (!e.target.closest('.menu-item')) closeAllMenus(); });

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SIDEBAR RESIZER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const resizer = document.getElementById('sidebar-resizer');
let isResizing = false;
resizer.addEventListener('mousedown', () => isResizing = true);
document.addEventListener('mousemove', (e) => {
  if (!isResizing) return;
  const sidebar = document.getElementById('sidebar');
  const newWidth = e.clientX - 48;
  if (newWidth > 100 && newWidth < 500) sidebar.style.width = newWidth + 'px';
});
document.addEventListener('mouseup', () => isResizing = false);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TITLE BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateTitlebar(name) {
  document.getElementById('titlebar-title').textContent = `${name} ‚Äî YSCode`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SETTINGS (stub) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openSettings() {
  const path = '__settings__';
  state.files[path] = {
    name: 'settings.json', content: JSON.stringify({
      "editor.fontSize": 13,
      "editor.tabSize": 2,
      "editor.fontFamily": "JetBrains Mono",
      "editor.lineNumbers": true,
      "workbench.colorTheme": "YSCode Dark",
      "terminal.integrated.shell": "web",
    }, null, 2),
    dirty: false, lang: 'JSON', fileObj: null,
  };
  openFile(path);
}

function openFindBar() {
  setActivity('search');
  setTimeout(() => document.getElementById('search-input').focus(), 100);
}

function refreshTree() { renderTree(); }

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg) {
  let t = document.getElementById('toast');
  if (!t) {
    t = document.createElement('div');
    t.id = 'toast';
    t.style.cssText = 'position:fixed;bottom:32px;right:16px;background:var(--bg-panel);border:1px solid var(--border);color:var(--text-bright);padding:8px 16px;border-radius:6px;font-size:12px;z-index:9999;opacity:0;transition:opacity 0.2s;font-family:var(--font-ui);pointer-events:none;';
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.opacity = '1';
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.style.opacity = '0', 2000);
}

function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
renderTree();
</script>
</body>
</html>