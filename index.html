<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YSCode - YallStudio Code</title>
<link rel="icon" href="icon.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,300;0,400;0,500;0,600;1,400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg-darkest:#0d0d0f; --bg-dark:#141416; --bg-mid:#1a1a1e;
  --bg-panel:#1e1e22; --bg-hover:#2a2a30; --bg-active:#2d2d34;
  --border:#2e2e36; --accent:#f0a500; --accent2:#e06c75;
  --accent3:#61afef; --accent4:#98c379; --accent5:#c678dd;
  --text-bright:#f0f0f5; --text-main:#c0c0cc; --text-dim:#6b6b7a;
  --text-dimmer:#44444f; --scrollbar:#2e2e36;
  --font-code:'JetBrains Mono',monospace; --font-ui:'Syne',sans-serif;
  --editor-font-size:13px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:var(--font-ui);background:var(--bg-darkest);color:var(--text-main);height:100vh;overflow:hidden;display:flex;flex-direction:column;user-select:none;}

/* TITLEBAR */
#titlebar{height:30px;background:var(--bg-darkest);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 12px;gap:8px;flex-shrink:0;}
.logo{display:flex;align-items:center;gap:6px;font-weight:800;font-size:12px;letter-spacing:.05em;color:var(--accent);}
.logo img{width:16px;height:16px;object-fit:contain;}
.logo span{color:var(--text-bright);}
#menu-bar{display:flex;gap:2px;margin-left:8px;}
.menu-item{font-size:12px;color:var(--text-main);cursor:pointer;padding:4px 8px;border-radius:4px;font-family:var(--font-ui);position:relative;}
.menu-item:hover,.menu-item.open{background:var(--bg-hover);color:var(--text-bright);}
.menu-dropdown{display:none;position:absolute;top:100%;left:0;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;min-width:190px;z-index:9000;padding:4px;box-shadow:0 8px 24px rgba(0,0,0,.6);}
.menu-item.open .menu-dropdown{display:block;}
.mdi{padding:6px 12px;font-size:12px;border-radius:4px;cursor:pointer;display:flex;justify-content:space-between;gap:24px;white-space:nowrap;color:var(--text-main);}
.mdi:hover{background:var(--bg-hover);color:var(--text-bright);}
.mdi .sc{color:var(--text-dim);}
.msep{height:1px;background:var(--border);margin:3px 0;}
#titlebar-title{flex:1;text-align:center;font-size:11px;color:var(--text-dim);letter-spacing:.03em;}
.font-controls{display:flex;align-items:center;gap:4px;margin-left:auto;}
.font-ctrl-btn{width:22px;height:22px;background:var(--bg-hover);border:1px solid var(--border);color:var(--text-main);border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;font-family:var(--font-ui);}
.font-ctrl-btn:hover{color:var(--text-bright);border-color:var(--accent);}
#font-size-display{font-size:11px;color:var(--text-dim);min-width:28px;text-align:center;}

/* ACTIVITY BAR */
#activity-bar{width:48px;background:var(--bg-dark);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;padding:4px 0;gap:2px;flex-shrink:0;}
.act-btn{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:6px;color:var(--text-dim);transition:color .15s,background .15s;position:relative;}
.act-btn:hover{color:var(--text-bright);background:var(--bg-hover);}
.act-btn.active{color:var(--text-bright);background:var(--bg-active);}
.act-btn.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:2px;height:20px;background:var(--accent);border-radius:0 2px 2px 0;}
#activity-bar .spacer{flex:1;}

/* WORKBENCH */
#workbench{display:flex;flex:1;overflow:hidden;}

/* SIDEBAR */
#sidebar{width:240px;background:var(--bg-dark);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;}
.sb-header{padding:10px 12px 6px;font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-dim);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
.sb-actions{display:flex;gap:2px;}
.sb-btn{width:22px;height:22px;display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:4px;color:var(--text-dim);transition:color .15s,background .15s;}
.sb-btn:hover{color:var(--text-bright);background:var(--bg-hover);}
#file-tree{flex:1;overflow-y:auto;padding:4px 0;}
#file-tree::-webkit-scrollbar{width:4px;}
#file-tree::-webkit-scrollbar-thumb{background:var(--scrollbar);border-radius:2px;}
.tree-empty{padding:20px 16px;font-size:12px;color:var(--text-dim);line-height:1.7;}
.open-btn{display:inline-block;margin-top:10px;padding:6px 14px;background:var(--accent);color:var(--bg-darkest);border-radius:5px;font-size:11px;font-weight:700;cursor:pointer;transition:opacity .15s;}
.open-btn:hover{opacity:.85;}
.tree-folder,.tree-file{display:flex;align-items:center;gap:5px;padding:2px 0;cursor:pointer;border-radius:3px;font-size:12.5px;font-family:var(--font-code);white-space:nowrap;overflow:hidden;}
.tree-folder:hover,.tree-file:hover{background:var(--bg-hover);}
.tree-file.active{background:var(--bg-active);color:var(--text-bright);}
.tree-icon{flex-shrink:0;font-size:13px;width:18px;text-align:center;}
.tree-name{overflow:hidden;text-overflow:ellipsis;flex:1;}
.tree-children{display:none;}
.tree-children.open{display:block;}
.tree-arrow{font-size:9px;color:var(--text-dim);flex-shrink:0;transition:transform .1s;margin-right:2px;}
.tree-arrow.open{transform:rotate(90deg);}

/* RECENT FOLDERS PANEL */
#panel-recent .recent-item{padding:8px 12px;font-size:12px;font-family:var(--font-code);cursor:pointer;border-radius:4px;color:var(--text-main);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
#panel-recent .recent-item:hover{background:var(--bg-hover);color:var(--text-bright);}
#panel-recent .recent-path{font-size:10px;color:var(--text-dim);}
.recent-clear{padding:8px 12px;font-size:11px;color:var(--text-dim);cursor:pointer;display:inline-block;}
.recent-clear:hover{color:var(--accent2);}

/* EXTENSIONS PANEL */
#panel-extensions{display:none;flex-direction:column;flex:1;overflow:hidden;}
#panel-extensions.active{display:flex;}
.ext-item{display:flex;gap:10px;padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;}
.ext-item:hover{background:var(--bg-hover);}
.ext-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.ext-info{flex:1;min-width:0;}
.ext-name{font-size:12px;font-weight:600;color:var(--text-bright);}
.ext-desc{font-size:11px;color:var(--text-dim);margin-top:2px;}
.ext-badge{font-size:10px;padding:1px 6px;border-radius:10px;margin-top:4px;display:inline-block;}
.ext-badge.installed{background:rgba(152,195,121,.15);color:var(--accent4);}
.ext-badge.available{background:rgba(97,175,239,.15);color:var(--accent3);}

/* SIDEBAR PANELS */
.sb-panel{display:none;flex-direction:column;flex:1;overflow:hidden;}
.sb-panel.active{display:flex;}
#search-panel-inner{flex:1;overflow-y:auto;padding:8px;}
.search-input-wrap{margin-bottom:6px;}
.search-input-wrap input{width:100%;background:var(--bg-mid);border:1px solid var(--border);color:var(--text-bright);padding:6px 10px;border-radius:5px;font-family:var(--font-code);font-size:12px;outline:none;}
.search-input-wrap input:focus{border-color:var(--accent);}
.search-result{padding:4px 6px;border-radius:4px;cursor:pointer;font-family:var(--font-code);font-size:11px;line-height:1.6;}
.search-result:hover{background:var(--bg-hover);}
.sr-file{color:var(--accent3);font-size:10px;font-weight:600;}
.sr-match{color:var(--text-main);}
.sr-match mark{background:rgba(240,165,0,.25);color:var(--accent);border-radius:2px;}

/* EDITOR AREA */
#editor-area{flex:1;display:flex;flex-direction:column;overflow:hidden;}

/* TABS */
#tabs-bar{height:35px;background:var(--bg-dark);border-bottom:1px solid var(--border);display:flex;overflow-x:auto;flex-shrink:0;align-items:flex-end;}
#tabs-bar::-webkit-scrollbar{height:0;}
.tab{height:35px;display:flex;align-items:center;gap:5px;padding:0 10px;font-size:12px;font-family:var(--font-code);cursor:pointer;border-right:1px solid var(--border);color:var(--text-dim);flex-shrink:0;position:relative;transition:color .1s,background .1s;min-width:80px;max-width:155px;}
.tab:hover{background:var(--bg-hover);color:var(--text-main);}
.tab.active{background:var(--bg-mid);color:var(--text-bright);border-top:2px solid var(--accent);}
.tab.drag-over{border-left:2px solid var(--accent3);}
.tab-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;}
.tab-close{font-size:13px;opacity:0;transition:opacity .1s;border-radius:3px;padding:0 2px;flex-shrink:0;line-height:1;}
.tab:hover .tab-close,.tab.active .tab-close{opacity:.5;}
.tab-close:hover{opacity:1!important;background:var(--bg-hover);}
.tab-dirty{width:6px;height:6px;background:var(--accent);border-radius:50%;flex-shrink:0;}

/* BREADCRUMB */
#breadcrumb{height:24px;background:var(--bg-panel);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 12px;gap:4px;font-size:11px;font-family:var(--font-code);color:var(--text-dim);flex-shrink:0;overflow:hidden;}
.bc-seg{cursor:pointer;border-radius:3px;padding:1px 4px;}
.bc-seg:hover{background:var(--bg-hover);color:var(--text-bright);}
.bc-sep{color:var(--text-dimmer);}

/* SPLIT EDITOR */
#split-container{display:flex;flex:1;overflow:hidden;}
#editor-left,#editor-right{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;}
#editor-right{border-left:1px solid var(--border);}
#split-resizer{width:4px;background:transparent;cursor:col-resize;flex-shrink:0;transition:background .2s;}
#split-resizer:hover,#split-resizer.dragging{background:var(--accent3);}
#split-resizer.hidden{display:none;}

/* WELCOME */
#welcome{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text-dim);background:var(--bg-mid);}
#welcome h2{font-family:var(--font-ui);font-size:26px;font-weight:800;color:var(--text-bright);opacity:.35;letter-spacing:-.02em;}
#welcome h2 span{color:var(--accent);}
#welcome p{font-size:12px;margin-top:6px;opacity:.4;}
#welcome .wshorts{margin-top:28px;display:flex;flex-direction:column;gap:6px;font-size:11px;font-family:var(--font-code);}
#welcome .ws-row{display:flex;gap:10px;align-items:center;}
#welcome kbd{background:var(--bg-panel);border:1px solid var(--border);padding:2px 6px;border-radius:4px;font-family:var(--font-code);font-size:10px;}

/* CODE EDITOR PANE */
.editor-pane{position:absolute;inset:0;display:none;flex-direction:column;}
.editor-pane.visible{display:flex;}
.editor-inner{flex:1;display:flex;overflow:hidden;position:relative;}

/* LINE NUMBERS */
.line-numbers{background:var(--bg-mid);color:var(--text-dimmer);font-family:var(--font-code);font-size:var(--editor-font-size);line-height:20px;padding:8px 10px 8px 8px;text-align:right;flex-shrink:0;overflow:hidden;white-space:pre;border-right:1px solid var(--border);pointer-events:none;user-select:none;min-width:44px;}

/* CODE AREA (highlighted) */
.code-wrapper{flex:1;position:relative;overflow:hidden;}
.code-highlight{position:absolute;inset:0;padding:8px 16px;font-family:var(--font-code);font-size:var(--editor-font-size);line-height:20px;white-space:pre;overflow:auto;pointer-events:none;color:transparent;tab-size:2;}
.code-area{position:absolute;inset:0;background:transparent;color:var(--text-main);font-family:var(--font-code);font-size:var(--editor-font-size);line-height:20px;padding:8px 16px;border:none;outline:none;resize:none;overflow:auto;caret-color:var(--accent);white-space:pre;tab-size:2;spellcheck:false;}
.code-area,.code-highlight{scrollbar-width:thin;scrollbar-color:var(--scrollbar) transparent;}
.code-area::-webkit-scrollbar,.code-highlight::-webkit-scrollbar{width:8px;height:8px;}
.code-area::-webkit-scrollbar-thumb,.code-highlight::-webkit-scrollbar-thumb{background:var(--scrollbar);border-radius:4px;}
.code-area::selection{background:rgba(240,165,0,.18);}

/* FIND/REPLACE BAR */
#find-bar{display:none;position:absolute;top:4px;right:12px;z-index:800;background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;padding:8px;box-shadow:0 4px 20px rgba(0,0,0,.5);flex-direction:column;gap:6px;min-width:300px;}
#find-bar.visible{display:flex;}
.find-row{display:flex;gap:6px;align-items:center;}
.find-input{flex:1;background:var(--bg-dark);border:1px solid var(--border);color:var(--text-bright);padding:5px 8px;border-radius:4px;font-family:var(--font-code);font-size:12px;outline:none;}
.find-input:focus{border-color:var(--accent);}
.find-btn{padding:4px 10px;background:var(--bg-hover);border:1px solid var(--border);color:var(--text-main);border-radius:4px;cursor:pointer;font-size:11px;font-family:var(--font-ui);white-space:nowrap;}
.find-btn:hover{color:var(--text-bright);}
.find-btn.primary{background:var(--accent);color:var(--bg-darkest);border-color:var(--accent);}
.find-count{font-size:11px;color:var(--text-dim);min-width:60px;}
.find-close{cursor:pointer;color:var(--text-dim);font-size:16px;padding:0 4px;}
.find-close:hover{color:var(--text-bright);}

/* AUTOCOMPLETE DROPDOWN */
.autocomplete-list{position:absolute;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;box-shadow:0 8px 24px rgba(0,0,0,.6);z-index:700;max-height:200px;overflow-y:auto;min-width:180px;display:none;}
.ac-item{padding:5px 10px;font-family:var(--font-code);font-size:12px;cursor:pointer;display:flex;align-items:center;gap:8px;}
.ac-item:hover,.ac-item.selected{background:var(--bg-hover);}
.ac-icon{font-size:11px;width:18px;text-align:center;flex-shrink:0;}
.ac-kind{font-size:10px;color:var(--text-dim);}
.ac-name{color:var(--text-bright);}
.ac-match{color:var(--accent);}

/* HTML PREVIEW */
#preview-panel{flex:1;display:flex;flex-direction:column;background:white;overflow:hidden;}
#preview-toolbar{height:30px;background:var(--bg-dark);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 10px;gap:8px;flex-shrink:0;}
#preview-toolbar span{font-size:11px;color:var(--text-dim);}
.preview-btn{padding:3px 10px;background:var(--bg-hover);border:1px solid var(--border);color:var(--text-main);border-radius:4px;cursor:pointer;font-size:11px;}
.preview-btn:hover{color:var(--text-bright);}
#preview-frame{flex:1;border:none;background:white;}

/* TERMINAL */
#terminal-panel{height:180px;background:var(--bg-darkest);border-top:1px solid var(--border);flex-shrink:0;display:none;flex-direction:column;}
#terminal-panel.visible{display:flex;}
#terminal-header{height:30px;background:var(--bg-dark);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 10px;gap:6px;font-size:11px;}
.term-tab{padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;}
.term-tab.active{background:var(--bg-active);color:var(--text-bright);}
#terminal-close{margin-left:auto;cursor:pointer;color:var(--text-dim);font-size:16px;width:22px;height:22px;display:flex;align-items:center;justify-content:center;border-radius:4px;}
#terminal-close:hover{background:var(--bg-hover);color:var(--text-bright);}
#terminal-output{flex:1;overflow-y:auto;padding:6px 12px;font-family:var(--font-code);font-size:12px;line-height:18px;}
#terminal-output::-webkit-scrollbar{width:4px;}
#terminal-output::-webkit-scrollbar-thumb{background:var(--scrollbar);}
#terminal-input-row{display:flex;align-items:center;padding:4px 12px 8px;gap:6px;font-family:var(--font-code);font-size:12px;}
#terminal-prompt{color:var(--accent4);}
#terminal-input{flex:1;background:transparent;border:none;outline:none;color:var(--text-bright);font-family:var(--font-code);font-size:12px;caret-color:var(--accent);}

/* STATUS BAR */
#statusbar{height:22px;background:var(--accent);display:flex;align-items:center;padding:0 12px;gap:14px;flex-shrink:0;}
.status-item{font-size:11px;color:var(--bg-darkest);font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px;font-family:var(--font-ui);}
.status-item:hover{opacity:.75;}
#statusbar .spacer{flex:1;}
#statusbar .status-right{display:flex;gap:14px;}

/* AI PANEL */
#ai-panel{width:280px;background:var(--bg-dark);border-left:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;display:none;}
#ai-panel.visible{display:flex;}
#ai-header{padding:10px 12px 8px;font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-dim);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);}
#ai-close{cursor:pointer;color:var(--text-dim);font-size:16px;}
#ai-close:hover{color:var(--text-bright);}
#ai-messages{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:10px;}
#ai-messages::-webkit-scrollbar{width:4px;}
#ai-messages::-webkit-scrollbar-thumb{background:var(--scrollbar);}
.ai-msg{padding:10px;border-radius:8px;font-size:12px;line-height:1.6;font-family:var(--font-code);}
.ai-msg.user{background:rgba(240,165,0,.1);border:1px solid rgba(240,165,0,.2);color:var(--text-bright);}
.ai-msg.assistant{background:var(--bg-panel);border:1px solid var(--border);color:var(--text-main);}
.ai-msg.loading{color:var(--text-dim);font-style:italic;}
.ai-msg pre{background:var(--bg-darkest);padding:8px;border-radius:4px;margin-top:6px;overflow-x:auto;font-size:11px;}
#ai-input-area{padding:8px;border-top:1px solid var(--border);}
#ai-input{width:100%;background:var(--bg-mid);border:1px solid var(--border);color:var(--text-bright);padding:8px;border-radius:6px;font-family:var(--font-code);font-size:12px;resize:none;outline:none;line-height:1.4;}
#ai-input:focus{border-color:var(--accent);}
#ai-actions{display:flex;gap:4px;margin-top:6px;}
.ai-action-btn{flex:1;padding:5px;background:var(--bg-hover);border:1px solid var(--border);color:var(--text-main);border-radius:4px;cursor:pointer;font-size:11px;font-family:var(--font-ui);}
.ai-action-btn:hover{color:var(--text-bright);}
.ai-action-btn.primary{background:var(--accent);color:var(--bg-darkest);border-color:var(--accent);}

/* CONTEXT MENU */
#ctx-menu{display:none;position:fixed;z-index:9999;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;padding:4px;min-width:170px;box-shadow:0 8px 24px rgba(0,0,0,.6);font-size:12px;}
.ctx-item{padding:6px 10px;border-radius:4px;cursor:pointer;display:flex;justify-content:space-between;gap:16px;color:var(--text-main);}
.ctx-item:hover{background:var(--bg-hover);color:var(--text-bright);}
.ctx-item.ai{color:var(--accent5);}
.ctx-sep{height:1px;background:var(--border);margin:3px 0;}

/* MODAL */
#modal-overlay{display:none;position:fixed;inset:0;z-index:9998;background:rgba(0,0,0,.7);align-items:flex-start;justify-content:center;padding-top:100px;}
#modal-overlay.visible{display:flex;}
#modal{background:var(--bg-panel);border:1px solid var(--border);border-radius:10px;width:500px;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,.8);}
#modal h3{font-size:14px;color:var(--text-bright);margin-bottom:12px;}
#modal input{width:100%;background:var(--bg-dark);border:1px solid var(--border);color:var(--text-bright);padding:8px 12px;border-radius:6px;font-family:var(--font-code);font-size:13px;outline:none;}
#modal input:focus{border-color:var(--accent);}
.modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;}
.btn-primary{padding:7px 16px;border-radius:5px;font-size:12px;font-family:var(--font-ui);font-weight:600;cursor:pointer;border:none;background:var(--accent);color:var(--bg-darkest);}
.btn-secondary{padding:7px 16px;border-radius:5px;font-size:12px;font-family:var(--font-ui);font-weight:600;cursor:pointer;border:none;background:var(--bg-hover);color:var(--text-main);}
button:hover{opacity:.85;}

/* SIDEBAR RESIZER */
#sidebar-resizer{width:4px;background:transparent;cursor:col-resize;flex-shrink:0;transition:background .2s;}
#sidebar-resizer:hover{background:var(--accent);}

/* ZEN MODE */
body.zen-mode #titlebar,
body.zen-mode #activity-bar,
body.zen-mode #sidebar,
body.zen-mode #sidebar-resizer,
body.zen-mode #terminal-panel,
body.zen-mode #statusbar{display:none!important;}

/* SYNTAX HIGHLIGHTING */
.hl-keyword{color:#c678dd;}
.hl-string{color:#98c379;}
.hl-comment{color:#5c6370;font-style:italic;}
.hl-number{color:#d19a66;}
.hl-function{color:#61afef;}
.hl-tag{color:#e06c75;}
.hl-attr{color:#d19a66;}
.hl-operator{color:#56b6c2;}
.hl-class{color:#e5c07b;}
.hl-builtin{color:#56b6c2;}
.hl-property{color:#abb2bf;}
.hl-punctuation{color:#abb2bf;}
.hl-regex{color:#56b6c2;}
.hl-type{color:#e5c07b;}

/* FOLD GUTTER */
.fold-gutter{background:var(--bg-mid);border-right:1px solid var(--border);width:14px;flex-shrink:0;font-family:var(--font-code);font-size:10px;line-height:20px;padding:8px 0;text-align:center;overflow:hidden;white-space:pre;}
.fold-marker{cursor:pointer;color:var(--text-dim);}
.fold-marker:hover{color:var(--accent);}

/* TOAST */
#toast{position:fixed;bottom:32px;right:16px;background:var(--bg-panel);border:1px solid var(--border);color:var(--text-bright);padding:8px 16px;border-radius:6px;font-size:12px;z-index:9999;opacity:0;transition:opacity .2s;font-family:var(--font-ui);pointer-events:none;box-shadow:0 4px 16px rgba(0,0,0,.4);}
</style>
</head>
<body>

<!-- TITLEBAR -->
<div id="titlebar">
  <div class="logo">
    <img src="icon.png" alt="" onerror="this.style.display='none'">
    <b>YS</b><span>Code</span>
  </div>
  <nav id="menu-bar">
    <div class="menu-item" id="mFile">File
      <div class="menu-dropdown">
        <div class="mdi" onclick="openFolder()">Open Folderâ€¦ <span class="sc">Ctrl+K O</span></div>
        <div class="mdi" onclick="newFile()">New File <span class="sc">Ctrl+N</span></div>
        <div class="msep"></div>
        <div class="mdi" onclick="saveFile()">Save <span class="sc">Ctrl+S</span></div>
        <div class="mdi" onclick="saveFileAs()">Save Asâ€¦ <span class="sc">Ctrl+Shift+S</span></div>
        <div class="msep"></div>
        <div class="mdi" onclick="closeTab()">Close Tab <span class="sc">Ctrl+W</span></div>
      </div>
    </div>
    <div class="menu-item" id="mEdit">Edit
      <div class="menu-dropdown">
        <div class="mdi" onclick="document.execCommand('undo')">Undo <span class="sc">Ctrl+Z</span></div>
        <div class="mdi" onclick="document.execCommand('redo')">Redo <span class="sc">Ctrl+Y</span></div>
        <div class="msep"></div>
        <div class="mdi" onclick="openFindBar()">Find <span class="sc">Ctrl+F</span></div>
        <div class="mdi" onclick="openFindBar(true)">Find & Replace <span class="sc">Ctrl+H</span></div>
        <div class="msep"></div>
        <div class="mdi" onclick="document.execCommand('selectAll')">Select All <span class="sc">Ctrl+A</span></div>
      </div>
    </div>
    <div class="menu-item" id="mView">View
      <div class="menu-dropdown">
        <div class="mdi" onclick="toggleSidebar()">Toggle Sidebar <span class="sc">Ctrl+B</span></div>
        <div class="mdi" onclick="toggleTerminal()">Terminal <span class="sc">Ctrl+`</span></div>
        <div class="mdi" onclick="toggleSplit()">Split Editor <span class="sc">Ctrl+\</span></div>
        <div class="mdi" onclick="toggleZen()">Zen Mode <span class="sc">Ctrl+K Z</span></div>
        <div class="mdi" onclick="toggleAIPanel()">AI Assistant <span class="sc">Ctrl+Shift+A</span></div>
        <div class="msep"></div>
        <div class="mdi" onclick="togglePreview()">Live HTML Preview <span class="sc">Ctrl+Shift+P</span></div>
      </div>
    </div>
    <div class="menu-item" id="mHelp">Help
      <div class="menu-dropdown">
        <div class="mdi" onclick="window.open('https://yallcode.github.io/YallCode/','_blank')">YallCode Website</div>
        <div class="mdi" onclick="showAbout()">About YSCode</div>
      </div>
    </div>
  </nav>
  <div id="titlebar-title">YSCode â€” YallStudio Code</div>
  <div class="font-controls">
    <div class="font-ctrl-btn" onclick="changeFontSize(-1)" title="Decrease font size">A-</div>
    <div id="font-size-display">13px</div>
    <div class="font-ctrl-btn" onclick="changeFontSize(1)" title="Increase font size">A+</div>
    <div class="font-ctrl-btn" onclick="changeFontSize(0)" title="Reset font size">â†º</div>
  </div>
</div>

<!-- WORKBENCH -->
<div id="workbench">

  <!-- ACTIVITY BAR -->
  <div id="activity-bar">
    <div class="act-btn active" id="act-explorer" title="Explorer (Ctrl+Shift+E)" onclick="setActivity('explorer')">
      <svg width="21" height="21" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="7" height="18" rx="1"/><rect x="14" y="3" width="7" height="8" rx="1"/><rect x="14" y="15" width="7" height="6" rx="1"/></svg>
    </div>
    <div class="act-btn" id="act-search" title="Search" onclick="setActivity('search')">
      <svg width="21" height="21" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/></svg>
    </div>
    <div class="act-btn" id="act-recent" title="Recent Folders" onclick="setActivity('recent')">
      <svg width="21" height="21" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/></svg>
    </div>
    <div class="act-btn" id="act-extensions" title="Extensions" onclick="setActivity('extensions')">
      <svg width="21" height="21" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5l6.74-6.76z"/><line x1="16" y1="8" x2="2" y2="22"/><line x1="17.5" y1="15" x2="9" y2="15"/></svg>
    </div>
    <div class="spacer"></div>
    <div class="act-btn" id="act-ai" title="AI Assistant (Ctrl+Shift+A)" onclick="toggleAIPanel()">
      <svg width="21" height="21" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 2a4 4 0 0 1 4 4v1h1a3 3 0 0 1 0 6h-1v1a4 4 0 0 1-8 0v-1H7a3 3 0 0 1 0-6h1V6a4 4 0 0 1 4-4z"/><circle cx="9" cy="9" r="1" fill="currentColor"/><circle cx="15" cy="9" r="1" fill="currentColor"/></svg>
    </div>
    <div class="act-btn" id="act-settings" title="Settings" onclick="openSettings()">
      <svg width="21" height="21" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div id="sidebar">

    <!-- EXPLORER -->
    <div class="sb-panel active" id="panel-explorer">
      <div class="sb-header">
        <span>Explorer</span>
        <div class="sb-actions">
          <div class="sb-btn" title="New File" onclick="newFileInFolder()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg></div>
          <div class="sb-btn" title="New Folder" onclick="newFolderInTree()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg></div>
          <div class="sb-btn" title="Open Folder" onclick="openFolder()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></div>
          <div class="sb-btn" title="Refresh" onclick="renderTree()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></div>
        </div>
      </div>
      <div id="file-tree"></div>
    </div>

    <!-- SEARCH -->
    <div class="sb-panel" id="panel-search">
      <div class="sb-header"><span>Search</span></div>
      <div id="search-panel-inner">
        <div class="search-input-wrap"><input type="text" id="search-input" placeholder="Search in filesâ€¦" oninput="doSearch(this.value)"/></div>
        <div id="search-results"></div>
      </div>
    </div>

    <!-- RECENT FOLDERS -->
    <div class="sb-panel" id="panel-recent">
      <div class="sb-header"><span>Recent Folders</span></div>
      <div id="recent-list" style="flex:1;overflow-y:auto;padding:4px;"></div>
      <span class="recent-clear" onclick="clearRecent()">Clear recent</span>
    </div>

    <!-- EXTENSIONS -->
    <div class="sb-panel" id="panel-extensions">
      <div class="sb-header"><span>Extensions</span></div>
      <div style="flex:1;overflow-y:auto;">
        <div class="ext-item">
          <div class="ext-icon" style="background:rgba(97,175,239,.15);">ğŸ¨</div>
          <div class="ext-info">
            <div class="ext-name">Dracula Theme</div>
            <div class="ext-desc">Dark theme for YSCode</div>
            <span class="ext-badge installed">â— Installed</span>
          </div>
        </div>
        <div class="ext-item">
          <div class="ext-icon" style="background:rgba(152,195,121,.15);">ğŸ“</div>
          <div class="ext-info">
            <div class="ext-name">Prettier</div>
            <div class="ext-desc">Code formatter</div>
            <span class="ext-badge installed">â— Installed</span>
          </div>
        </div>
        <div class="ext-item">
          <div class="ext-icon" style="background:rgba(198,120,221,.15);">âš¡</div>
          <div class="ext-info">
            <div class="ext-name">Auto Rename Tag</div>
            <div class="ext-desc">Auto rename paired HTML tag</div>
            <span class="ext-badge available">+ Available</span>
          </div>
        </div>
        <div class="ext-item">
          <div class="ext-icon" style="background:rgba(224,108,117,.15);">ğŸ”¥</div>
          <div class="ext-info">
            <div class="ext-name">GitLens</div>
            <div class="ext-desc">Git supercharged</div>
            <span class="ext-badge available">+ Available</span>
          </div>
        </div>
        <div class="ext-item">
          <div class="ext-icon" style="background:rgba(240,165,0,.15);">ğŸ¤–</div>
          <div class="ext-info">
            <div class="ext-name">YSCode AI</div>
            <div class="ext-desc">Powered by Claude</div>
            <span class="ext-badge installed">â— Installed</span>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- SIDEBAR RESIZER -->
  <div id="sidebar-resizer"></div>

  <!-- EDITOR AREA -->
  <div id="editor-area">
    <div id="tabs-bar"></div>
    <div id="breadcrumb"><span style="color:var(--text-dimmer)">No file open</span></div>

    <div id="split-container">
      <!-- LEFT (main) editor -->
      <div id="editor-left">
        <div id="welcome">
          <div style="font-size:52px;opacity:.12;margin-bottom:14px;">
            <svg width="52" height="52" viewBox="0 0 64 64" fill="none"><rect width="64" height="64" rx="12" fill="#f0a500" fill-opacity=".15"/><text x="50%" y="56%" dominant-baseline="middle" text-anchor="middle" font-size="30" font-family="Syne,sans-serif" font-weight="800" fill="#f0a500">YS</text></svg>
          </div>
          <h2><span>YS</span>Code</h2>
          <p>YallStudio Code â€” Web IDE</p>
          <div class="wshorts">
            <div class="ws-row"><kbd>Ctrl+N</kbd> New File</div>
            <div class="ws-row"><kbd>Ctrl+K O</kbd> Open Folder</div>
            <div class="ws-row"><kbd>Ctrl+F</kbd> Find</div>
            <div class="ws-row"><kbd>Ctrl+H</kbd> Find & Replace</div>
            <div class="ws-row"><kbd>Ctrl+\</kbd> Split Editor</div>
            <div class="ws-row"><kbd>Ctrl+Shift+A</kbd> AI Assistant</div>
          </div>
        </div>
      </div>

      <!-- SPLIT RESIZER -->
      <div id="split-resizer" class="hidden"></div>

      <!-- RIGHT editor (split) -->
      <div id="editor-right" style="display:none;"></div>
    </div>

    <!-- TERMINAL -->
    <div id="terminal-panel">
      <div id="terminal-header">
        <div class="term-tab active">TERMINAL</div>
        <div class="term-tab">OUTPUT</div>
        <div id="terminal-close" onclick="toggleTerminal()">âœ•</div>
      </div>
      <div id="terminal-output"><span style="color:var(--accent4)">YSCode Terminal v2.0</span><br><span style="color:var(--text-dim)">Type 'help' for available commands</span><br><br></div>
      <div id="terminal-input-row">
        <span id="terminal-prompt">user@yscode:~$&nbsp;</span>
        <input type="text" id="terminal-input" spellcheck="false" onkeydown="handleTerminalKey(event)"/>
      </div>
    </div>
  </div>

  <!-- AI PANEL -->
  <div id="ai-panel">
    <div id="ai-header">
      <span>ğŸ¤– AI Assistant</span>
      <span id="ai-close" onclick="toggleAIPanel()">âœ•</span>
    </div>
    <div id="ai-messages">
      <div class="ai-msg assistant">ğŸ‘‹ Hi! I'm your AI assistant. Select code and right-click to <b>Explain</b> or <b>Fix</b> it, or ask me anything below.</div>
    </div>
    <div id="ai-input-area">
      <textarea id="ai-input" rows="3" placeholder="Ask about your codeâ€¦" onkeydown="handleAIKey(event)"></textarea>
      <div id="ai-actions">
        <button class="ai-action-btn" onclick="aiExplainSelected()">âœ¨ Explain selection</button>
        <button class="ai-action-btn primary" onclick="sendAIMessage()">Send â†µ</button>
      </div>
    </div>
  </div>

</div>
 
<!-- STATUS BAR -->
<div id="statusbar">
  <div class="status-item" id="sb-branch">â‡ main</div>
  <div class="status-item" id="sb-file">No file</div>
  <div class="spacer"></div>
  <div class="status-right">
    <div class="status-item" id="sb-cursor">Ln 1, Col 1</div>
    <div class="status-item" id="sb-lang">Plain Text</div>
    <div class="status-item" id="sb-encoding">UTF-8</div>
    <div class="status-item" onclick="window.open('https://yallcode.github.io/YallCode/','_blank')">YallCode â†—</div>
  </div>
</div>

<!-- CONTEXT MENU -->
<div id="ctx-menu">
  <div class="ctx-item" id="ctx-open">Open File</div>
  <div class="ctx-item" id="ctx-rename">Rename</div>
  <div class="ctx-item" id="ctx-delete">Delete</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="newFileInFolder();closeCtxMenu()">New File</div>
  <div class="ctx-item" onclick="newFolderInTree();closeCtxMenu()">New Folder</div>
  <div class="ctx-sep" id="ctx-ai-sep"></div>
  <div class="ctx-item ai" id="ctx-ai-explain">ğŸ¤– AI Explain Selection</div>
  <div class="ctx-item ai" id="ctx-ai-fix">ğŸ”§ AI Fix Selection</div>
</div>

<!-- MODAL -->
<div id="modal-overlay">
  <div id="modal">
    <h3 id="modal-title">New File</h3>
    <input type="text" id="modal-input" placeholder="filename.js"/>
    <div class="modal-btns">
      <button class="btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn-primary" id="modal-confirm">OK</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<!-- FILE INPUTS -->
<input type="file" id="file-input" style="display:none" webkitdirectory multiple/>
<input type="file" id="single-file-input" style="display:none" multiple/>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  files: {}, folders: {}, rootPath: null,
  openTabs: [], activeTab: null, splitTab: null,
  dirHandles: {}, fileHandles: {},
  recentFolders: JSON.parse(localStorage.getItem('yscode-recent')||'[]'),
  splitEnabled: false, zenMode: false, aiPanelVisible: false,
  fontSize: 13, activity: 'explorer',
  foldedLines: {}, // path -> Set of line indices
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE ICON MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ICONS = {
  js:'ğŸŸ¨',mjs:'ğŸŸ¨',cjs:'ğŸŸ¨', ts:'ğŸ”·',tsx:'âš›ï¸',jsx:'âš›ï¸',
  html:'ğŸŒ',htm:'ğŸŒ', css:'ğŸ¨',scss:'ğŸ¨',sass:'ğŸ¨',less:'ğŸ¨',
  json:'ğŸ“‹',jsonc:'ğŸ“‹', py:'ğŸ', md:'ğŸ“',mdx:'ğŸ“',
  txt:'ğŸ“„', sh:'ğŸ’²',bash:'ğŸ’²',zsh:'ğŸ’²',
  yaml:'âš™ï¸',yml:'âš™ï¸', xml:'ğŸ“°',svg:'ğŸ–¼ï¸',
  c:'ğŸ”µ',cpp:'ğŸ”µ',h:'ğŸ”µ',hpp:'ğŸ”µ',
  java:'â˜•', rs:'ğŸ¦€', go:'ğŸ¹', php:'ğŸ˜', rb:'ğŸ’',
  vue:'ğŸ’š', swift:'ğŸŠ', kt:'ğŸŸ£', dart:'ğŸ¯',
  sql:'ğŸ—„ï¸', csv:'ğŸ“Š', env:'ğŸ”’',
  png:'ğŸ–¼ï¸',jpg:'ğŸ–¼ï¸',jpeg:'ğŸ–¼ï¸',gif:'ğŸ–¼ï¸',webp:'ğŸ–¼ï¸',ico:'ğŸ–¼ï¸',
  pdf:'ğŸ“•', zip:'ğŸ“¦', tar:'ğŸ“¦', gz:'ğŸ“¦',
};
const LANGS = {
  js:'JavaScript',mjs:'JavaScript',cjs:'JavaScript',
  ts:'TypeScript',tsx:'TypeScript (React)',jsx:'JavaScript (React)',
  html:'HTML',htm:'HTML',css:'CSS',scss:'SCSS',sass:'Sass',less:'Less',
  json:'JSON',jsonc:'JSON',py:'Python',md:'Markdown',mdx:'MDX',
  txt:'Plain Text',sh:'Shell',bash:'Shell',
  yaml:'YAML',yml:'YAML',xml:'XML',svg:'SVG',
  c:'C',cpp:'C++',h:'C Header',java:'Java',rs:'Rust',
  go:'Go',php:'PHP',rb:'Ruby',vue:'Vue',swift:'Swift',kt:'Kotlin',
  dart:'Dart',sql:'SQL',csv:'CSV',env:'ENV',
};
function ext(name){ return (name.split('.').pop()||'').toLowerCase(); }
function getIcon(name){ return ICONS[ext(name)]||'ğŸ“„'; }
function getLang(name){ return LANGS[ext(name)]||'Plain Text'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FONT SIZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function changeFontSize(delta){
  if(delta===0){S.fontSize=13;}
  else{S.fontSize=Math.max(10,Math.min(24,S.fontSize+delta));}
  document.documentElement.style.setProperty('--editor-font-size',S.fontSize+'px');
  document.getElementById('font-size-display').textContent=S.fontSize+'px';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OPEN FOLDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openFolder(){
  if(window.showDirectoryPicker){
    try{
      const dh=await window.showDirectoryPicker({mode:'readwrite'});
      await loadDirHandle(dh,null,0);
      addRecent(dh.name);
      return;
    }catch(e){if(e.name==='AbortError')return;}
  }
  document.getElementById('file-input').click();
}

async function loadDirHandle(dh,parentPath,depth){
  if(!parentPath){
    S.files={};S.folders={};S.rootPath=null;
    S.openTabs=[];S.activeTab=null;S.splitTab=null;
    S.dirHandles={};S.fileHandles={};
    renderTabs();showWelcome();
  }
  const name=dh.name;
  const path=parentPath?`${parentPath}/${name}`:name;
  if(!S.rootPath)S.rootPath=path;
  S.folders[path]={name,children:[],isFolder:true,depth};
  S.dirHandles[path]=dh;
  if(parentPath&&S.folders[parentPath])S.folders[parentPath].children.push(path);
  for await(const[en,eh] of dh.entries()){
    if(en.startsWith('.'))continue;
    if(eh.kind==='directory'){await loadDirHandle(eh,path,depth+1);}
    else{
      const fp=`${path}/${en}`;
      S.folders[path].children.push(fp);
      S.files[fp]={name:en,content:null,dirty:false,lang:getLang(en),fileHandle:eh,fileObj:null};
      S.fileHandles[fp]=eh;
    }
  }
  if(!parentPath){renderTree();updateTitlebar(name);}
}

// Legacy fallback
document.getElementById('file-input').addEventListener('change',async function(e){
  const files=Array.from(e.target.files);
  if(!files.length)return;
  S.files={};S.folders={};S.rootPath=null;S.openTabs=[];S.activeTab=null;
  S.dirHandles={};S.fileHandles={};
  renderTabs();showWelcome();
  const rootName=files[0].webkitRelativePath.split('/')[0];
  S.rootPath=rootName;
  S.folders[rootName]={name:rootName,children:[],isFolder:true,depth:0};
  for(const file of files){
    const parts=file.webkitRelativePath.split('/');
    const fp=file.webkitRelativePath;
    for(let i=1;i<parts.length;i++){
      const folderPath=parts.slice(0,i).join('/');
      const parentPath=parts.slice(0,i-1).join('/')||rootName;
      if(!S.folders[folderPath]&&i<parts.length-1){
        S.folders[folderPath]={name:parts[i-1],children:[],isFolder:true,depth:i-1};
        const p=S.folders[parentPath];
        if(p&&!p.children.includes(folderPath))p.children.push(folderPath);
      }
    }
    const pp=parts.slice(0,-1).join('/');
    const par=S.folders[pp];
    if(par&&!par.children.includes(fp))par.children.push(fp);
    S.files[fp]={name:parts[parts.length-1],content:null,dirty:false,lang:getLang(parts[parts.length-1]),fileHandle:null,fileObj:file};
  }
  renderTree();updateTitlebar(rootName);
  addRecent(rootName);
  this.value='';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECENT FOLDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addRecent(name){
  S.recentFolders=S.recentFolders.filter(r=>r!==name);
  S.recentFolders.unshift(name);
  S.recentFolders=S.recentFolders.slice(0,10);
  localStorage.setItem('yscode-recent',JSON.stringify(S.recentFolders));
  renderRecent();
}
function clearRecent(){
  S.recentFolders=[];
  localStorage.setItem('yscode-recent','[]');
  renderRecent();
}
function renderRecent(){
  const el=document.getElementById('recent-list');
  if(!S.recentFolders.length){
    el.innerHTML='<div style="padding:16px 12px;font-size:12px;color:var(--text-dim)">No recent folders.</div>';
    return;
  }
  el.innerHTML=S.recentFolders.map(r=>`
    <div class="recent-item" onclick="showToast('Re-open: use Open Folder to navigate to ${escH(r)}')">
      <div>ğŸ“ ${escH(r)}</div>
    </div>`).join('');
}
renderRecent();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TREE RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTree(){
  const tree=document.getElementById('file-tree');
  if(!S.rootPath){
    tree.innerHTML=`<div class="tree-empty">No folder opened.<br><div class="open-btn" onclick="openFolder()">Open Folder</div></div>`;
    return;
  }
  tree.innerHTML='';
  renderNode(S.rootPath,tree,0,true);
}

function renderNode(path,container,depth,isRoot){
  const node=S.folders[path]||S.files[path];
  if(!node)return;
  const isFolder=!!S.folders[path];
  const el=document.createElement('div');
  const indent=depth*14;

  if(isFolder){
    el.className='tree-folder';
    el.style.paddingLeft=`${6+indent}px`;
    const isOpen=isRoot?'true':'false';
    el.dataset.open=isOpen;
    el.innerHTML=`<span class="tree-arrow${isRoot?' open':''}" style="padding-left:${isRoot?0:2}px">â–¶</span><span class="tree-icon">${isRoot?'ğŸ“‚':'ğŸ“'}</span><span class="tree-name">${escH(node.name)}</span>`;
    const cc=document.createElement('div');
    cc.className='tree-children'+(isRoot?' open':'');
    el.addEventListener('click',e=>{
      e.stopPropagation();
      const open=el.dataset.open==='true';
      el.dataset.open=open?'false':'true';
      const arr=el.querySelector('.tree-arrow');
      const ico=el.querySelector('.tree-icon');
      arr.classList.toggle('open',!open);
      ico.textContent=(!open)?'ğŸ“‚':'ğŸ“';
      cc.classList.toggle('open',!open);
    });
    el.addEventListener('contextmenu',e=>showCtxMenu(e,path,true));
    container.appendChild(el);
    container.appendChild(cc);
    const children=(node.children||[]).slice().sort((a,b)=>{
      const af=!!S.folders[a],bf=!!S.folders[b];
      if(af!==bf)return af?-1:1;
      return (S.folders[a]||S.files[a]).name.localeCompare((S.folders[b]||S.files[b]).name);
    });
    for(const c of children)renderNode(c,cc,depth+1,false);
  }else{
    el.className='tree-file';
    el.style.paddingLeft=`${20+indent}px`;
    el.innerHTML=`<span class="tree-icon">${getIcon(node.name)}</span><span class="tree-name">${escH(node.name)}</span>`;
    el.dataset.path=path;
    if(S.activeTab===path)el.classList.add('active');
    el.addEventListener('click',()=>openFile(path));
    el.addEventListener('contextmenu',e=>showCtxMenu(e,path,false));
    container.appendChild(el);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OPEN FILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openFile(path,side='left'){
  const file=S.files[path];
  if(!file)return;
  // Load content
  if(file.content===null){
    if(file.fileHandle){const f=await file.fileHandle.getFile();file.content=await f.text();}
    else if(file.fileObj){file.content=await file.fileObj.text();}
    else file.content='';
  }
  document.querySelectorAll('.tree-file').forEach(e=>e.classList.remove('active'));
  const tEl=document.querySelector(`.tree-file[data-path="${CSS.escape(path)}"]`);
  if(tEl)tEl.classList.add('active');

  if(side==='right'){
    S.splitTab=path;
    renderEditor(path,'right');
    return;
  }
  if(!S.openTabs.includes(path))S.openTabs.push(path);
  S.activeTab=path;
  renderTabs();
  renderEditor(path,'left');
  updateBreadcrumb(path);
  updateStatus(path);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTabs(){
  const bar=document.getElementById('tabs-bar');
  bar.innerHTML='';
  for(const path of S.openTabs){
    const file=S.files[path];
    if(!file)continue;
    const tab=document.createElement('div');
    tab.className='tab'+(path===S.activeTab?' active':'');
    tab.draggable=true;
    tab.dataset.path=path;
    tab.innerHTML=`<span style="font-size:12px">${getIcon(file.name)}</span><span class="tab-name">${escH(file.name)}</span>${file.dirty?'<span class="tab-dirty"></span>':''}<span class="tab-close" data-close="${path}">âœ•</span>`;
    tab.addEventListener('click',e=>{
      if(e.target.dataset.close)closeTabByPath(e.target.dataset.close);
      else switchTab(path);
    });
    // Drag-to-reorder
    tab.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',path);});
    tab.addEventListener('dragover',e=>{e.preventDefault();tab.classList.add('drag-over');});
    tab.addEventListener('dragleave',()=>tab.classList.remove('drag-over'));
    tab.addEventListener('drop',e=>{
      e.preventDefault();tab.classList.remove('drag-over');
      const src=e.dataTransfer.getData('text/plain');
      if(src&&src!==path){
        const si=S.openTabs.indexOf(src);
        const ti=S.openTabs.indexOf(path);
        if(si>-1&&ti>-1){S.openTabs.splice(si,1);S.openTabs.splice(ti,0,src);}
        renderTabs();
      }
    });
    bar.appendChild(tab);
  }
  if(!S.openTabs.length)showWelcome();
}

function switchTab(path){S.activeTab=path;renderTabs();renderEditor(path,'left');updateBreadcrumb(path);updateStatus(path);}
function closeTab(){if(S.activeTab)closeTabByPath(S.activeTab);}
function closeTabByPath(path){
  const idx=S.openTabs.indexOf(path);
  if(idx<0)return;
  S.openTabs.splice(idx,1);
  if(S.activeTab===path)S.activeTab=S.openTabs[idx]||S.openTabs[idx-1]||null;
  const pid=paneId(path);
  const p=document.getElementById(pid);
  if(p)p.remove();
  renderTabs();
  if(S.activeTab){renderEditor(S.activeTab,'left');updateBreadcrumb(S.activeTab);updateStatus(S.activeTab);}
  else{showWelcome();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDITOR RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function paneId(path,side='left'){return 'pane-'+(side==='right'?'R-':'')+(btoa(unescape(encodeURIComponent(path))).replace(/[^a-zA-Z0-9]/g,'').substring(0,18));}

function showWelcome(){
  document.getElementById('welcome').style.display='flex';
  document.querySelectorAll('.editor-pane').forEach(p=>p.classList.remove('visible'));
}

function renderEditor(path,side='left'){
  const file=S.files[path];
  if(!file)return;
  const container=side==='left'?document.getElementById('editor-left'):document.getElementById('editor-right');
  document.getElementById('welcome').style.display='none';
  // Hide all panes in this container
  container.querySelectorAll('.editor-pane').forEach(p=>p.classList.remove('visible'));

  const pid=paneId(path,side);
  let pane=document.getElementById(pid);
  if(!pane){
    pane=createEditorPane(path,pid,side);
    container.appendChild(pane);
  }
  // Update content if changed
  const ta=pane.querySelector('.code-area');
  if(ta&&ta.value!==file.content){
    ta.value=file.content||'';
    highlightPane(pane,path);
    updateLineNumbers(pane.querySelector('.line-numbers'),file.content||'');
  }
  pane.classList.add('visible');
  setTimeout(()=>{const t=pane.querySelector('.code-area');if(t){t.focus();updateCursor(t);}},30);
}

function createEditorPane(path,pid,side){
  const file=S.files[path];
  const pane=document.createElement('div');
  pane.className='editor-pane';pane.id=pid;

  const inner=document.createElement('div');inner.className='editor-inner';
  const lineNums=document.createElement('div');lineNums.className='line-numbers';
  const wrapper=document.createElement('div');wrapper.className='code-wrapper';
  const highlight=document.createElement('div');highlight.className='code-highlight';
  const ta=document.createElement('textarea');ta.className='code-area';ta.spellcheck=false;ta.autocomplete='off';ta.autocorrect='off';ta.autocapitalize='off';
  ta.value=file.content||'';
  updateLineNumbers(lineNums,file.content||'');

  // Autocomplete list
  const acList=document.createElement('div');acList.className='autocomplete-list';acList.id=pid+'-ac';

  // Find bar
  const findBar=document.createElement('div');findBar.className='find-bar';findBar.id=pid+'-find';
  findBar.innerHTML=`
    <div class="find-row">
      <input class="find-input" id="${pid}-fi" placeholder="Findâ€¦" oninput="doFind('${pid}')"/>
      <span class="find-count" id="${pid}-fc"></span>
      <button class="find-btn" onclick="findNext('${pid}',false)">â†‘</button>
      <button class="find-btn" onclick="findNext('${pid}',true)">â†“</button>
      <span class="find-close" onclick="closeFindBar('${pid}')">âœ•</span>
    </div>
    <div class="find-row" id="${pid}-rrow" style="display:none">
      <input class="find-input" id="${pid}-ri" placeholder="Replaceâ€¦"/>
      <button class="find-btn" onclick="doReplace('${pid}',false)">Replace</button>
      <button class="find-btn primary" onclick="doReplace('${pid}',true)">All</button>
    </div>`;

  ta.addEventListener('input',()=>{
    file.content=ta.value;file.dirty=true;
    updateLineNumbers(lineNums,ta.value);
    highlightPaneTA(highlight,ta.value,path);
    syncScroll(ta,highlight,lineNums);
    renderTabs();
    showAutocomplete(ta,acList,path,pid);
  });
  ta.addEventListener('keydown',e=>handleEditorKey(e,ta,path,pane,pid,acList));
  ta.addEventListener('click',()=>{updateCursor(ta);hideAC(acList);});
  ta.addEventListener('keyup',()=>updateCursor(ta));
  ta.addEventListener('scroll',()=>syncScroll(ta,highlight,lineNums));
  ta.addEventListener('contextmenu',e=>{
    const sel=ta.value.substring(ta.selectionStart,ta.selectionEnd).trim();
    showEditorCtxMenu(e,sel,path);
  });

  highlight.addEventListener('scroll',()=>{ta.scrollTop=highlight.scrollTop;ta.scrollLeft=highlight.scrollLeft;});

  wrapper.appendChild(highlight);wrapper.appendChild(ta);wrapper.appendChild(acList);wrapper.appendChild(findBar);
  inner.appendChild(lineNums);inner.appendChild(wrapper);
  pane.appendChild(inner);
  highlightPaneTA(highlight,file.content||'',path);
  return pane;
}

function syncScroll(ta,hl,ln){
  hl.scrollTop=ta.scrollTop;hl.scrollLeft=ta.scrollLeft;
  ln.scrollTop=ta.scrollTop;
}

function updateLineNumbers(el,text){
  const n=text.split('\n').length;
  el.textContent=Array.from({length:n},(_,i)=>i+1).join('\n');
}

function updateCursor(ta){
  const txt=ta.value.substring(0,ta.selectionStart);
  const lines=txt.split('\n');
  document.getElementById('sb-cursor').textContent=`Ln ${lines.length}, Col ${lines[lines.length-1].length+1}`;
}

function updateStatus(path){
  const f=S.files[path];
  if(!f)return;
  document.getElementById('sb-file').textContent=f.name;
  document.getElementById('sb-lang').textContent=f.lang;
}

function updateBreadcrumb(path){
  const parts=path.split('/');
  const bc=document.getElementById('breadcrumb');
  bc.innerHTML=parts.map((p,i)=>{
    const isLast=i===parts.length-1;
    return `<span class="bc-seg" style="${isLast?'color:var(--text-bright)':''}">${escH(p)}</span>${isLast?'':'<span class="bc-sep"> â€º </span>'}`;
  }).join('');
}

function updateTitlebar(n){document.getElementById('titlebar-title').textContent=`${n} â€” YSCode`;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYNTAX HIGHLIGHTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function highlightPane(pane,path){
  const ta=pane.querySelector('.code-area');
  const hl=pane.querySelector('.code-highlight');
  if(ta&&hl)highlightPaneTA(hl,ta.value,path);
}

function highlightPaneTA(hl,code,path){
  const e=ext(S.files[path]?.name||path);
  hl.innerHTML=highlight(code,e);
}

function highlight(code,lang){
  const safe=escH(code);
  if(['js','mjs','cjs','ts','jsx','tsx'].includes(lang))return hlJS(safe);
  if(['html','htm'].includes(lang))return hlHTML(safe);
  if(['css','scss','less','sass'].includes(lang))return hlCSS(safe);
  if(lang==='py')return hlPython(safe);
  if(['json','jsonc'].includes(lang))return hlJSON(safe);
  return safe;
}

function hlJS(c){
  const kw=/\b(const|let|var|function|class|return|if|else|for|while|do|switch|case|break|continue|import|export|default|from|new|this|typeof|instanceof|in|of|try|catch|finally|throw|async|await|yield|delete|void|null|undefined|true|false|super|extends|implements|interface|type|enum|static|public|private|protected|readonly|abstract|namespace|module|declare|require)\b/g;
  return c
    .replace(/(`(?:[^`\\]|\\.)*`|'(?:[^'\\]|\\.)*'|"(?:[^"\\]|\\.)*")/g,m=>`<span class="hl-string">${m}</span>`)
    .replace(/(\/\/[^\n]*)/g,m=>`<span class="hl-comment">${m}</span>`)
    .replace(/(\/\*[\s\S]*?\*\/)/g,m=>`<span class="hl-comment">${m}</span>`)
    .replace(/\b(\d+\.?\d*)\b/g,m=>`<span class="hl-number">${m}</span>`)
    .replace(kw,m=>`<span class="hl-keyword">${m}</span>`)
    .replace(/\b([A-Z][a-zA-Z0-9_]*)\b/g,m=>`<span class="hl-class">${m}</span>`)
    .replace(/\b([a-zA-Z_$][a-zA-Z0-9_$]*)\s*(?=\()/g,m=>`<span class="hl-function">${m}</span>`);
}

function hlHTML(c){
  return c
    .replace(/(&lt;!--[\s\S]*?--&gt;)/g,m=>`<span class="hl-comment">${m}</span>`)
    .replace(/(&lt;\/?)([\w-]+)/g,(m,lt,tag)=>`${lt}<span class="hl-tag">${tag}</span>`)
    .replace(/([\w-]+)(?=\s*=\s*(?:"[^"]*"|'[^']*'|[^\s>]*))/g,m=>`<span class="hl-attr">${m}</span>`)
    .replace(/("[^"]*"|'[^']*')/g,m=>`<span class="hl-string">${m}</span>`);
}

function hlCSS(c){
  return c
    .replace(/(\/\*[\s\S]*?\*\/)/g,m=>`<span class="hl-comment">${m}</span>`)
    .replace(/("[^"]*"|'[^']*')/g,m=>`<span class="hl-string">${m}</span>`)
    .replace(/(#[0-9a-fA-F]{3,8})\b/g,m=>`<span class="hl-number">${m}</span>`)
    .replace(/\b(\d+\.?\d*)(px|em|rem|vh|vw|%|s|ms|deg|fr)?\b/g,m=>`<span class="hl-number">${m}</span>`)
    .replace(/([\w-]+)(?=\s*:)/g,m=>`<span class="hl-attr">${m}</span>`)
    .replace(/(@[\w-]+)/g,m=>`<span class="hl-keyword">${m}</span>`);
}

function hlPython(c){
  const kw=/\b(def|class|return|if|elif|else|for|while|import|from|as|with|try|except|finally|raise|in|not|and|or|is|None|True|False|pass|break|continue|lambda|yield|global|nonlocal|del|assert|async|await)\b/g;
  return c
    .replace(/("""[\s\S]*?"""|'''[\s\S]*?'''|"[^"]*"|'[^']*')/g,m=>`<span class="hl-string">${m}</span>`)
    .replace(/(#[^\n]*)/g,m=>`<span class="hl-comment">${m}</span>`)
    .replace(/\b(\d+\.?\d*)\b/g,m=>`<span class="hl-number">${m}</span>`)
    .replace(kw,m=>`<span class="hl-keyword">${m}</span>`)
    .replace(/\b([A-Z][a-zA-Z0-9_]*)\b/g,m=>`<span class="hl-class">${m}</span>`)
    .replace(/\b([a-zA-Z_][a-zA-Z0-9_]*)\s*(?=\()/g,m=>`<span class="hl-function">${m}</span>`);
}

function hlJSON(c){
  return c
    .replace(/("[^"]*")\s*:/g,m=>`<span class="hl-attr">${m}</span>`)
    .replace(/:\s*("[^"]*")/g,(m,v)=>m.replace(v,`<span class="hl-string">${v}</span>`))
    .replace(/\b(\d+\.?\d*)\b/g,m=>`<span class="hl-number">${m}</span>`)
    .replace(/\b(true|false|null)\b/g,m=>`<span class="hl-keyword">${m}</span>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTOCOMPLETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const JS_SNIPPETS=[
  {label:'console.log',kind:'fn',insert:'console.log($1)'},
  {label:'function',kind:'kw',insert:'function $1($2) {\n  $3\n}'},
  {label:'const',kind:'kw',insert:'const $1 = $2'},
  {label:'let',kind:'kw',insert:'let $1 = $2'},
  {label:'if',kind:'kw',insert:'if ($1) {\n  $2\n}'},
  {label:'for',kind:'kw',insert:'for (let $1 = 0; $1 < $2; $1++) {\n  $3\n}'},
  {label:'forEach',kind:'fn',insert:'forEach(($1) => {\n  $2\n})'},
  {label:'map',kind:'fn',insert:'map(($1) => $2)'},
  {label:'filter',kind:'fn',insert:'filter(($1) => $2)'},
  {label:'async',kind:'kw',insert:'async function $1($2) {\n  $3\n}'},
  {label:'await',kind:'kw',insert:'await $1'},
  {label:'import',kind:'kw',insert:"import $1 from '$2'"},
  {label:'export default',kind:'kw',insert:'export default $1'},
  {label:'class',kind:'kw',insert:'class $1 {\n  constructor($2) {\n    $3\n  }\n}'},
  {label:'return',kind:'kw',insert:'return $1'},
  {label:'try',kind:'kw',insert:'try {\n  $1\n} catch ($2) {\n  $3\n}'},
];
const HTML_SNIPPETS=[
  {label:'div',kind:'tag',insert:'<div>$1</div>'},
  {label:'span',kind:'tag',insert:'<span>$1</span>'},
  {label:'button',kind:'tag',insert:'<button>$1</button>'},
  {label:'input',kind:'tag',insert:'<input type="$1"/>'},
  {label:'p',kind:'tag',insert:'<p>$1</p>'},
  {label:'h1',kind:'tag',insert:'<h1>$1</h1>'},
  {label:'a href',kind:'tag',insert:'<a href="$1">$2</a>'},
  {label:'img',kind:'tag',insert:'<img src="$1" alt="$2"/>'},
  {label:'ul > li',kind:'tag',insert:'<ul>\n  <li>$1</li>\n</ul>'},
  {label:'script',kind:'tag',insert:'<script>\n  $1\n<\/script>'},
  {label:'style',kind:'tag',insert:'<style>\n  $1\n</style>'},
  {label:'html:5',kind:'snip',insert:'<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <title>$1</title>\n</head>\n<body>\n  $2\n</body>\n</html>'},
];

function getSnippets(path){
  const e2=ext(S.files[path]?.name||'');
  if(['js','ts','jsx','tsx','mjs'].includes(e2))return JS_SNIPPETS;
  if(['html','htm'].includes(e2))return HTML_SNIPPETS;
  return [];
}

let acIdx=0;
function showAutocomplete(ta,acList,path,pid){
  const pos=ta.selectionStart;
  const before=ta.value.substring(0,pos);
  const word=before.match(/[\w.]+$/)?.[0]||'';
  if(word.length<2){hideAC(acList);return;}
  const snips=getSnippets(path);
  // Also collect words from file
  const fileWords=[...new Set((ta.value.match(/\b[a-zA-Z_$][a-zA-Z0-9_$]{2,}\b/g)||[]))].filter(w=>w.toLowerCase().includes(word.toLowerCase())&&w!==word);
  const matched=[
    ...snips.filter(s=>s.label.toLowerCase().startsWith(word.toLowerCase())),
    ...fileWords.slice(0,8).map(w=>({label:w,kind:'word',insert:w})),
  ].slice(0,12);
  if(!matched.length){hideAC(acList);return;}
  acIdx=0;
  // Position
  const coords=getCaretCoords(ta);
  acList.style.left=coords.left+'px';
  acList.style.top=(coords.top+20)+'px';
  acList.style.display='block';
  acList.innerHTML=matched.map((s,i)=>{
    const kindIcon={fn:'Æ’',kw:'K',tag:'<>',snip:'âœ‚',word:'W'}[s.kind]||'Â·';
    return `<div class="ac-item${i===0?' selected':''}" data-idx="${i}" data-insert="${escH(s.insert)}" data-word="${escH(word)}">
      <span class="ac-icon">${kindIcon}</span>
      <span class="ac-name">${escH(s.label.replace(new RegExp(escRe(word),'i'),m=>`</span><span class="ac-match">${escH(m)}</span><span class="ac-name">`))} </span>
    </div>`;
  }).join('');
  acList.querySelectorAll('.ac-item').forEach(item=>{
    item.addEventListener('mousedown',e=>{
      e.preventDefault();
      insertACItem(ta,item.dataset.insert,item.dataset.word,path);
      hideAC(acList);
    });
  });
}

function hideAC(acList){if(acList)acList.style.display='none';}

function insertACItem(ta,insert,word,path){
  const pos=ta.selectionStart;
  const before=ta.value.substring(0,pos);
  const after=ta.value.substring(pos);
  const wordStart=pos-word.length;
  const clean=insert.replace(/\$\d/g,'');
  ta.value=ta.value.substring(0,wordStart)+clean+after;
  ta.selectionStart=ta.selectionEnd=wordStart+clean.length;
  S.files[path].content=ta.value;
  S.files[path].dirty=true;
  const pane=ta.closest('.editor-pane');
  if(pane){
    updateLineNumbers(pane.querySelector('.line-numbers'),ta.value);
    highlightPaneTA(pane.querySelector('.code-highlight'),ta.value,path);
  }
  renderTabs();
}

function getCaretCoords(ta){
  // approximate caret position
  const lines=ta.value.substring(0,ta.selectionStart).split('\n');
  const line=lines.length;
  const col=lines[lines.length-1].length;
  const lineH=20,charW=S.fontSize*0.6;
  const rect=ta.getBoundingClientRect();
  return{left:col*charW,top:(line-1)*lineH-ta.scrollTop+8};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDITOR KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleEditorKey(e,ta,path,pane,pid,acList){
  // Autocomplete nav
  if(acList.style.display==='block'){
    const items=acList.querySelectorAll('.ac-item');
    if(e.key==='ArrowDown'){e.preventDefault();acIdx=Math.min(acIdx+1,items.length-1);items.forEach((it,i)=>it.classList.toggle('selected',i===acIdx));acList.children[acIdx]?.scrollIntoView({block:'nearest'});return;}
    if(e.key==='ArrowUp'){e.preventDefault();acIdx=Math.max(acIdx-1,0);items.forEach((it,i)=>it.classList.toggle('selected',i===acIdx));return;}
    if(e.key==='Tab'||e.key==='Enter'){
      const sel=items[acIdx];
      if(sel){e.preventDefault();insertACItem(ta,sel.dataset.insert,sel.dataset.word,path);hideAC(acList);return;}
    }
    if(e.key==='Escape'){hideAC(acList);return;}
  }

  if(e.ctrlKey&&e.key==='s'){e.preventDefault();saveFile();return;}
  if(e.ctrlKey&&e.key==='w'){e.preventDefault();closeTab();return;}
  if(e.ctrlKey&&e.key==='f'){e.preventDefault();openFindBar();return;}
  if(e.ctrlKey&&e.key==='h'){e.preventDefault();openFindBar(true);return;}

  // Tab â†’ 2 spaces
  if(e.key==='Tab'&&!e.ctrlKey){
    e.preventDefault();
    const s=ta.selectionStart,en=ta.selectionEnd;
    if(e.shiftKey){
      // unindent
      const lines=ta.value.substring(0,s).split('\n');
      const lineStart=s-lines[lines.length-1].length;
      if(ta.value.substr(lineStart,2)==='  '){
        ta.value=ta.value.substring(0,lineStart)+ta.value.substring(lineStart+2);
        ta.selectionStart=ta.selectionEnd=s-2;
      }
    }else{
      ta.value=ta.value.substring(0,s)+'  '+ta.value.substring(en);
      ta.selectionStart=ta.selectionEnd=s+2;
    }
    S.files[path].content=ta.value;S.files[path].dirty=true;
    updateLineNumbers(pane.querySelector('.line-numbers'),ta.value);
    highlightPaneTA(pane.querySelector('.code-highlight'),ta.value,path);
    renderTabs();return;
  }

  // Auto-close brackets / quotes
  const pairs={'(':')','{':'}','[':']','"':'"',"'":"'",'`':'`'};
  if(pairs[e.key]&&!e.ctrlKey&&!e.altKey){
    const s=ta.selectionStart,en=ta.selectionEnd;
    if(s===en){
      e.preventDefault();
      const open=e.key,close=pairs[e.key];
      ta.value=ta.value.substring(0,s)+open+close+ta.value.substring(en);
      ta.selectionStart=ta.selectionEnd=s+1;
      S.files[path].content=ta.value;
    }
  }

  // Enter â†’ auto-indent
  if(e.key==='Enter'&&!e.ctrlKey){
    const s=ta.selectionStart;
    const lineStart=ta.value.lastIndexOf('\n',s-1)+1;
    const currentLine=ta.value.substring(lineStart,s);
    const indent=currentLine.match(/^(\s*)/)[1];
    const prevChar=ta.value[s-1];
    const nextChar=ta.value[s];
    if(prevChar==='{' && nextChar==='}'){
      e.preventDefault();
      const ins='\n'+indent+'  '+'\n'+indent;
      ta.value=ta.value.substring(0,s)+ins+ta.value.substring(s);
      ta.selectionStart=ta.selectionEnd=s+indent.length+3;
      S.files[path].content=ta.value;S.files[path].dirty=true;
      updateLineNumbers(pane.querySelector('.line-numbers'),ta.value);
      highlightPaneTA(pane.querySelector('.code-highlight'),ta.value,path);
      renderTabs();return;
    }
    if(indent){
      e.preventDefault();
      const extraIndent=prevChar==='{' ? '  ':'' ;
      ta.value=ta.value.substring(0,s)+'\n'+indent+extraIndent+ta.value.substring(s);
      ta.selectionStart=ta.selectionEnd=s+1+indent.length+extraIndent.length;
      S.files[path].content=ta.value;S.files[path].dirty=true;
      updateLineNumbers(pane.querySelector('.line-numbers'),ta.value);
      highlightPaneTA(pane.querySelector('.code-highlight'),ta.value,path);
      renderTabs();return;
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIND & REPLACE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getActiveFindBar(){
  if(!S.activeTab)return null;
  const pid=paneId(S.activeTab,'left');
  return document.getElementById(pid+'-find');
}
function openFindBar(withReplace=false){
  const fb=getActiveFindBar();
  if(!fb)return;
  fb.classList.add('visible');
  const rrow=fb.querySelector('[id$="-rrow"]');
  if(rrow)rrow.style.display=withReplace?'flex':'none';
  const fi=fb.querySelector('[id$="-fi"]');
  if(fi){fi.focus();fi.select();}
}
function closeFindBar(pid){
  const fb=document.getElementById(pid+'-find');
  if(fb)fb.classList.remove('visible');
  clearHighlights(pid);
}

let findMatches=[];let findIdx=0;
function doFind(pid){
  clearHighlights(pid);
  const fb=document.getElementById(pid+'-find');
  if(!fb)return;
  const q=fb.querySelector('[id$="-fi"]')?.value;
  if(!q){document.getElementById(pid+'-fc').textContent='';return;}
  const pane=document.getElementById(pid);
  if(!pane)return;
  const ta=pane.querySelector('.code-area');
  const text=ta.value;
  findMatches=[];
  let i=0;
  while((i=text.toLowerCase().indexOf(q.toLowerCase(),i))>-1){findMatches.push(i);i+=q.length;}
  document.getElementById(pid+'-fc').textContent=findMatches.length?`${Math.min(findIdx+1,findMatches.length)}/${findMatches.length}`:'No results';
  if(findMatches.length){findIdx=0;ta.setSelectionRange(findMatches[0],findMatches[0]+q.length);ta.focus();}
}
function findNext(pid,forward){
  if(!findMatches.length)return;
  const fb=document.getElementById(pid+'-find');
  const q=fb?.querySelector('[id$="-fi"]')?.value||'';
  findIdx=forward?(findIdx+1)%findMatches.length:(findIdx-1+findMatches.length)%findMatches.length;
  const pane=document.getElementById(pid);
  const ta=pane?.querySelector('.code-area');
  if(ta){ta.setSelectionRange(findMatches[findIdx],findMatches[findIdx]+q.length);ta.focus();}
  document.getElementById(pid+'-fc').textContent=`${findIdx+1}/${findMatches.length}`;
}
function doReplace(pid,all){
  const fb=document.getElementById(pid+'-find');
  const fi=fb?.querySelector('[id$="-fi"]')?.value||'';
  const ri=fb?.querySelector('[id$="-ri"]')?.value||'';
  if(!fi||!S.activeTab)return;
  const file=S.files[S.activeTab];
  if(!file)return;
  if(all){
    file.content=file.content.split(fi).join(ri);
  }else{
    const i=file.content.toLowerCase().indexOf(fi.toLowerCase());
    if(i>-1)file.content=file.content.substring(0,i)+ri+file.content.substring(i+fi.length);
  }
  file.dirty=true;
  const pane=document.getElementById(pid);
  const ta=pane?.querySelector('.code-area');
  if(ta){ta.value=file.content;updateLineNumbers(pane.querySelector('.line-numbers'),file.content);highlightPaneTA(pane.querySelector('.code-highlight'),file.content,S.activeTab);}
  renderTabs();doFind(pid);
}
function clearHighlights(pid){}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveFile(){
  if(!S.activeTab){newFile();return;}
  const file=S.files[S.activeTab];
  if(!file)return;
  if(file.fileHandle){
    try{
      const w=await file.fileHandle.createWritable();
      await w.write(file.content||'');await w.close();
      file.dirty=false;renderTabs();showToast('âœ“ Saved: '+file.name);return;
    }catch(err){
      if(err.name==='NotAllowedError'){showToast('âš  Permission denied â€” re-open folder');return;}
    }
  }
  if(window.showSaveFilePicker){
    try{
      const e2=ext(file.name);
      const h=await window.showSaveFilePicker({suggestedName:file.name,types:[{description:'Text',accept:{'text/plain':['.'+e2]}}]});
      const w=await h.createWritable();await w.write(file.content||'');await w.close();
      file.fileHandle=h;file.dirty=false;renderTabs();showToast('âœ“ Saved: '+file.name);return;
    }catch(e){if(e.name==='AbortError')return;}
  }
  // download fallback
  const blob=new Blob([file.content||''],{type:'text/plain'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=file.name;a.click();
  file.dirty=false;renderTabs();showToast('Downloaded: '+file.name);
}

async function saveFileAs(){
  if(!S.activeTab)return;
  const file=S.files[S.activeTab];
  if(!file)return;
  if(window.showSaveFilePicker){
    try{
      const h=await window.showSaveFilePicker({suggestedName:file.name});
      const w=await h.createWritable();await w.write(file.content||'');await w.close();
      file.fileHandle=h;file.dirty=false;renderTabs();showToast('âœ“ Saved as: '+h.name);return;
    }catch(e){if(e.name==='AbortError')return;}
  }
  showModalPrompt('Save As',file.name,name=>{
    if(!name)return;
    const blob=new Blob([file.content||''],{type:'text/plain'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEW FILE / FOLDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function newFile(){
  showModalPrompt('New File','untitled.txt',name=>{
    if(!name)return;
    const path=(S.rootPath?S.rootPath+'/':'')+name;
    S.files[path]={name,content:'',dirty:false,lang:getLang(name),fileHandle:null,fileObj:null};
    if(S.rootPath&&S.folders[S.rootPath])S.folders[S.rootPath].children.push(path);
    renderTree();openFile(path);
  });
}
function newFileInFolder(){newFile();}
function newFolderInTree(){
  showModalPrompt('New Folder','new-folder',name=>{
    if(!name||!S.rootPath)return;
    const path=S.rootPath+'/'+name;
    S.folders[path]={name,children:[],isFolder:true,depth:1};
    S.folders[S.rootPath].children.push(path);
    renderTree();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPLIT EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSplit(){
  S.splitEnabled=!S.splitEnabled;
  const right=document.getElementById('editor-right');
  const res=document.getElementById('split-resizer');
  right.style.display=S.splitEnabled?'':'none';
  res.classList.toggle('hidden',!S.splitEnabled);
  if(S.splitEnabled&&S.activeTab){
    const path=S.openTabs[1]||S.activeTab;
    S.splitTab=path;
    renderEditor(path,'right');
  }
  showToast(S.splitEnabled?'Split editor on':'Split editor off');
}

// Split resizer drag
const splitRes=document.getElementById('split-resizer');
let splitDragging=false,splitStartX=0,splitLeftW=0;
splitRes.addEventListener('mousedown',e=>{
  splitDragging=true;splitStartX=e.clientX;
  const left=document.getElementById('editor-left');
  splitLeftW=left.getBoundingClientRect().width;
  splitRes.classList.add('dragging');
});
document.addEventListener('mousemove',e=>{
  if(!splitDragging)return;
  const delta=e.clientX-splitStartX;
  const left=document.getElementById('editor-left');
  const container=document.getElementById('split-container');
  const total=container.getBoundingClientRect().width;
  const newW=Math.max(200,Math.min(total-200,splitLeftW+delta));
  left.style.flex='none';left.style.width=newW+'px';
});
document.addEventListener('mouseup',()=>{splitDragging=false;splitRes.classList.remove('dragging');});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVE HTML PREVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let previewVisible=false;
function togglePreview(){
  if(!S.activeTab){showToast('Open an HTML file first');return;}
  const file=S.files[S.activeTab];
  if(!file){return;}
  previewVisible=!previewVisible;
  let pp=document.getElementById('preview-panel');
  if(previewVisible){
    if(!pp){
      pp=document.createElement('div');pp.id='preview-panel';pp.className='preview-panel';
      pp.innerHTML=`<div class="preview-toolbar">
        <span>ğŸŒ Live Preview â€” ${escH(file.name)}</span>
        <button class="preview-btn" onclick="refreshPreview()">â†º Refresh</button>
        <button class="preview-btn" onclick="togglePreview()">âœ• Close</button>
      </div><iframe id="preview-frame"></iframe>`;
      document.getElementById('editor-area').appendChild(pp);
    }
    pp.style.display='flex';
    refreshPreview();
  }else{
    if(pp)pp.style.display='none';
  }
}
function refreshPreview(){
  const file=S.activeTab?S.files[S.activeTab]:null;
  if(!file)return;
  const frame=document.getElementById('preview-frame');
  if(!frame)return;
  const blob=new Blob([file.content||''],{type:'text/html'});
  frame.src=URL.createObjectURL(blob);
  showToast('Preview refreshed');
}

// Auto-refresh preview on edit
function maybeRefreshPreview(){
  if(previewVisible){
    clearTimeout(window._previewTimer);
    window._previewTimer=setTimeout(refreshPreview,800);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TERMINAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleTerminal(){
  const tp=document.getElementById('terminal-panel');
  const vis=tp.classList.toggle('visible');
  if(vis)document.getElementById('terminal-input').focus();
}
const termHistory=[];let termHistIdx=-1;
const termCmds={
  help:()=>'Commands:\n  clear, ls, pwd, echo, date, about, cat [file], open [file]',
  clear:()=>{document.getElementById('terminal-output').innerHTML='';return null;},
  ls:()=>Object.values(S.files).map(f=>f.name).join('  ')||'(empty)',
  pwd:()=>S.rootPath?'/'+S.rootPath:'~',
  date:()=>new Date().toString(),
  about:()=>'YSCode v2.0 â€” YallStudio Code\nhttps://yallcode.github.io/YallCode/',
  cat:args=>{const f=Object.values(S.files).find(f=>f.name===args);return f?(f.content||'(empty)'):'File not found: '+args;},
  open:args=>{const e=Object.entries(S.files).find(([,f])=>f.name===args);if(e){openFile(e[0]);}return e?'Opening '+args:'Not found: '+args;},
};
function handleTerminalKey(e){
  const input=document.getElementById('terminal-input');
  if(e.key==='Enter'){
    const cmd=input.value.trim();if(!cmd)return;
    termHistory.unshift(cmd);termHistIdx=-1;
    const out=document.getElementById('terminal-output');
    out.innerHTML+=`<span style="color:var(--accent4)">$</span> <span style="color:var(--text-bright)">${escH(cmd)}</span>\n`;
    const parts=cmd.split(' ');
    const fn=termCmds[parts[0]];
    if(fn){const r=fn(parts.slice(1).join(' '));if(r!=null)out.innerHTML+=escH(r)+'\n';}
    else if(parts[0]==='echo'){out.innerHTML+=escH(parts.slice(1).join(' '))+'\n';}
    else{out.innerHTML+=`<span style="color:var(--accent2)">Not found: ${escH(parts[0])}</span>\n`;}
    out.innerHTML+='\n';out.scrollTop=out.scrollHeight;input.value='';
  }else if(e.key==='ArrowUp'){termHistIdx=Math.min(termHistIdx+1,termHistory.length-1);input.value=termHistory[termHistIdx]||'';}
  else if(e.key==='ArrowDown'){termHistIdx=Math.max(termHistIdx-1,-1);input.value=termHistIdx>=0?termHistory[termHistIdx]:'';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI ASSISTANT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleAIPanel(){
  S.aiPanelVisible=!S.aiPanelVisible;
  document.getElementById('ai-panel').classList.toggle('visible',S.aiPanelVisible);
}

async function sendAIMessage(injected){
  const inputEl=document.getElementById('ai-input');
  const msg=injected||inputEl.value.trim();
  if(!msg)return;
  if(!injected)inputEl.value='';

  const msgs=document.getElementById('ai-messages');
  msgs.innerHTML+=`<div class="ai-msg user">${escH(msg)}</div>`;
  const loadingDiv=document.createElement('div');
  loadingDiv.className='ai-msg loading';loadingDiv.textContent='â³ Thinkingâ€¦';
  msgs.appendChild(loadingDiv);msgs.scrollTop=msgs.scrollHeight;

  // Build context
  const activeFile=S.activeTab?S.files[S.activeTab]:null;
  const context=activeFile?`\nCurrent file: ${activeFile.name}\n\`\`\`\n${(activeFile.content||'').substring(0,3000)}\n\`\`\``:'\n(No file open)';

  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1000,
        system:`You are an expert coding assistant inside YSCode, a web-based code editor. Help the user with their code concisely and clearly. Format code in \`\`\`code blocks\`\`\`. ${context}`,
        messages:[{role:'user',content:msg}]
      })
    });
    const data=await res.json();
    const reply=data.content?.[0]?.text||'Sorry, no response received.';
    loadingDiv.className='ai-msg assistant';
    loadingDiv.innerHTML=formatAIReply(reply);
  }catch(err){
    loadingDiv.className='ai-msg assistant';
    loadingDiv.innerHTML=`<span style="color:var(--accent2)">Error: ${escH(err.message)}</span>`;
  }
  msgs.scrollTop=msgs.scrollHeight;
}

function formatAIReply(text){
  return escH(text)
    .replace(/```([\w]*)\n?([\s\S]*?)```/g,(_,lang,code)=>`<pre><code>${code}</code></pre>`)
    .replace(/`([^`]+)`/g,(_,c)=>`<code style="background:var(--bg-darkest);padding:1px 4px;border-radius:3px;font-size:11px;">${c}</code>`)
    .replace(/\*\*([^*]+)\*\*/g,'<b>$1</b>')
    .replace(/\n/g,'<br>');
}

function aiExplainSelected(){
  if(!S.activeTab)return;
  if(!S.aiPanelVisible)toggleAIPanel();
  const pane=document.getElementById(paneId(S.activeTab,'left'));
  const ta=pane?.querySelector('.code-area');
  const sel=ta?ta.value.substring(ta.selectionStart,ta.selectionEnd).trim():'';
  if(sel){sendAIMessage(`Explain this code:\n\`\`\`\n${sel}\n\`\`\``);}
  else{sendAIMessage('Explain the current file briefly.');}
}

function aiFixSelected(){
  if(!S.activeTab)return;
  if(!S.aiPanelVisible)toggleAIPanel();
  const pane=document.getElementById(paneId(S.activeTab,'left'));
  const ta=pane?.querySelector('.code-area');
  const sel=ta?ta.value.substring(ta.selectionStart,ta.selectionEnd).trim():'';
  if(sel){sendAIMessage(`Fix any bugs or issues in this code and return the corrected version:\n\`\`\`\n${sel}\n\`\`\``);}
  else{sendAIMessage('Review the current file for bugs or issues and suggest fixes.');}
}

function handleAIKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendAIMessage();}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doSearch(query){
  const results=document.getElementById('search-results');
  results.innerHTML='';
  if(!query.trim())return;
  const q=query.toLowerCase();let found=0;
  for(const[path,file] of Object.entries(S.files)){
    if(!file.content)continue;
    const lines=file.content.split('\n');
    for(let i=0;i<lines.length;i++){
      if(lines[i].toLowerCase().includes(q)){
        const div=document.createElement('div');div.className='search-result';
        const hl=escH(lines[i]).replace(new RegExp(escRe(escH(query)),'gi'),m=>`<mark>${m}</mark>`);
        div.innerHTML=`<div class="sr-file">${escH(file.name)}:${i+1}</div><div class="sr-match">${hl}</div>`;
        div.addEventListener('click',()=>{openFile(path);setActivity('explorer');});
        results.appendChild(div);
        if(++found>=60)return;
      }
    }
  }
  if(!found)results.innerHTML='<div style="padding:8px;font-size:11px;color:var(--text-dim)">No results.</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTEXT MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ctxTarget=null;
function showCtxMenu(e,path,isFolder){
  e.preventDefault();e.stopPropagation();
  ctxTarget=path;
  const m=document.getElementById('ctx-menu');
  document.getElementById('ctx-open').style.display=isFolder?'none':'';
  document.getElementById('ctx-ai-sep').style.display=isFolder?'none':'';
  document.getElementById('ctx-ai-explain').style.display=isFolder?'none':'';
  document.getElementById('ctx-ai-fix').style.display=isFolder?'none':'';
  m.style.left=Math.min(e.clientX,innerWidth-180)+'px';
  m.style.top=Math.min(e.clientY,innerHeight-220)+'px';
  m.style.display='block';
  document.getElementById('ctx-open').onclick=()=>{openFile(path);closeCtxMenu();};
  document.getElementById('ctx-rename').onclick=()=>{
    const node=S.files[path]||S.folders[path];
    showModalPrompt('Rename',node.name,n=>{if(n){node.name=n;renderTree();}});closeCtxMenu();
  };
  document.getElementById('ctx-delete').onclick=()=>{
    if(S.files[path]){delete S.files[path];closeTabByPath(path);}
    else delete S.folders[path];
    renderTree();closeCtxMenu();
  };
  document.getElementById('ctx-ai-explain').onclick=()=>{openFile(path).then(()=>aiExplainSelected());closeCtxMenu();};
  document.getElementById('ctx-ai-fix').onclick=()=>{openFile(path).then(()=>aiFixSelected());closeCtxMenu();};
}

function showEditorCtxMenu(e,sel,path){
  e.preventDefault();
  const m=document.getElementById('ctx-menu');
  document.getElementById('ctx-open').style.display='none';
  document.getElementById('ctx-rename').style.display='none';
  document.getElementById('ctx-delete').style.display='none';
  document.getElementById('ctx-ai-sep').style.display=sel?'':'none';
  document.getElementById('ctx-ai-explain').style.display='';
  document.getElementById('ctx-ai-fix').style.display='';
  document.getElementById('ctx-ai-explain').textContent=sel?'ğŸ¤– AI Explain Selection':'ğŸ¤– AI Explain File';
  document.getElementById('ctx-ai-fix').textContent=sel?'ğŸ”§ AI Fix Selection':'ğŸ”§ AI Review File';
  m.style.left=Math.min(e.clientX,innerWidth-180)+'px';
  m.style.top=Math.min(e.clientY,innerHeight-120)+'px';
  m.style.display='block';
  document.getElementById('ctx-ai-explain').onclick=()=>{aiExplainSelected();closeCtxMenu();};
  document.getElementById('ctx-ai-fix').onclick=()=>{aiFixSelected();closeCtxMenu();};
}

function closeCtxMenu(){
  const m=document.getElementById('ctx-menu');m.style.display='none';
  // restore
  ['ctx-open','ctx-rename','ctx-delete'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='';});
}
document.addEventListener('click',e=>{if(!e.target.closest('#ctx-menu'))closeCtxMenu();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIVITY / SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setActivity(name){
  closeAllMenus();S.activity=name;
  document.querySelectorAll('.act-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('act-'+name)?.classList.add('active');
  document.querySelectorAll('.sb-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('panel-'+name)?.classList.add('active');
  if(!document.getElementById('sidebar').style.display||document.getElementById('sidebar').style.display==='none'){toggleSidebar();}
}
function toggleSidebar(){
  const sb=document.getElementById('sidebar');
  const res=document.getElementById('sidebar-resizer');
  const hidden=sb.style.display==='none';
  sb.style.display=hidden?'':'none';
  res.style.display=hidden?'':'none';
}
function toggleZen(){
  S.zenMode=!S.zenMode;
  document.body.classList.toggle('zen-mode',S.zenMode);
  showToast(S.zenMode?'Zen mode on â€” press Ctrl+K Z to exit':'Zen mode off');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _modalCb=null;
function showModalPrompt(title,placeholder,cb){
  document.getElementById('modal-title').textContent=title;
  const inp=document.getElementById('modal-input');
  inp.placeholder=placeholder;inp.value=placeholder;
  document.getElementById('modal-overlay').classList.add('visible');
  _modalCb=cb;
  setTimeout(()=>{inp.focus();inp.select();},50);
  document.getElementById('modal-confirm').onclick=()=>{if(_modalCb)_modalCb(inp.value.trim());closeModal();};
  inp.onkeydown=e=>{if(e.key==='Enter')document.getElementById('modal-confirm').click();};
}
function closeModal(){document.getElementById('modal-overlay').classList.remove('visible');_modalCb=null;}
document.getElementById('modal-overlay').addEventListener('click',function(e){if(e.target===this)closeModal();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.menu-item').forEach(mi=>{
  mi.addEventListener('click',e=>{
    e.stopPropagation();
    const wasOpen=mi.classList.contains('open');
    closeAllMenus();
    if(!wasOpen)mi.classList.add('open');
  });
});
function closeAllMenus(){document.querySelectorAll('.menu-item.open').forEach(m=>m.classList.remove('open'));}
document.addEventListener('click',()=>closeAllMenus());

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR RESIZER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sbResizing=false;
document.getElementById('sidebar-resizer').addEventListener('mousedown',()=>sbResizing=true);
document.addEventListener('mousemove',e=>{
  if(!sbResizing)return;
  const w=e.clientX-48;
  if(w>100&&w<500)document.getElementById('sidebar').style.width=w+'px';
});
document.addEventListener('mouseup',()=>sbResizing=false);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSettings(){
  const path='__settings__';
  S.files[path]={name:'settings.json',content:JSON.stringify({"editor.fontSize":S.fontSize,"editor.tabSize":2,"editor.fontFamily":"JetBrains Mono","workbench.colorTheme":"YSCode Dark","editor.wordWrap":"off","ai.model":"claude-sonnet-4-20250514"},null,2),dirty:false,lang:'JSON',fileHandle:null,fileObj:null};
  openFile(path);
}
function showAbout(){showToast('YSCode v2.0 â€” YallStudio Code');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBAL KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  if(e.ctrlKey&&e.key==='n'){e.preventDefault();newFile();}
  if(e.ctrlKey&&e.key==='b'){e.preventDefault();toggleSidebar();}
  if(e.ctrlKey&&e.key==='`'){e.preventDefault();toggleTerminal();}
  if(e.ctrlKey&&e.key==='w'){e.preventDefault();closeTab();}
  if(e.ctrlKey&&e.key==='s'){e.preventDefault();saveFile();}
  if(e.ctrlKey&&e.key==='\\'){e.preventDefault();toggleSplit();}
  if(e.ctrlKey&&e.shiftKey&&e.key==='A'){e.preventDefault();toggleAIPanel();}
  if(e.ctrlKey&&e.shiftKey&&e.key==='P'){e.preventDefault();togglePreview();}
  if(e.ctrlKey&&e.key==='='||e.ctrlKey&&e.key==='+'){e.preventDefault();changeFontSize(1);}
  if(e.ctrlKey&&e.key==='-'){e.preventDefault();changeFontSize(-1);}
  if(e.ctrlKey&&e.key==='k'){
    // wait for next key
    window._kChord=true;
    setTimeout(()=>window._kChord=false,1500);
  }
  if(window._kChord&&e.key==='z'){e.preventDefault();toggleZen();window._kChord=false;}
  if(window._kChord&&e.key==='o'){e.preventDefault();openFolder();window._kChord=false;}
  if(e.key==='Escape'){closeCtxMenu();closeModal();closeAllMenus();}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAG & DROP FILES ONTO EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('editor-left').addEventListener('dragover',e=>{e.preventDefault();});
document.getElementById('editor-left').addEventListener('drop',async e=>{
  e.preventDefault();
  for(const file of e.dataTransfer.files){
    const path=file.name;
    S.files[path]={name:file.name,content:await file.text(),dirty:false,lang:getLang(file.name),fileHandle:null,fileObj:null};
    openFile(path);
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.style.opacity='1';
  clearTimeout(t._t);t._t=setTimeout(()=>t.style.opacity='0',2200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escH(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function escRe(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderTree();
</script>
</body>
</html>